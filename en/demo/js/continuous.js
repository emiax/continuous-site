Function.prototype.method=function(a,b){this.prototype[a]=b;return this};Function.method("extend",function(a){this.prototype.constructor=this;for(var b in a)a.hasOwnProperty(b)&&(this.prototype[b]=a[b]);return this});Function.extend({inheritsFrom:function(a,b){this.prototype=new a;this.prototype.superMethod=a.prototype;b&&this.extend(b);return this}});var CALC=function(){return{}}();CALC.Exception=function(){this.name="Unexpected Exception";this.message="Sorry!"};CALC.InvalidArgumentException=function(a){this.name="Invalid argument";this.message="Invalid argument: "+a};CALC.NotImplementedYetException=function(){this.name="Not implemented yet";this.message="This feature it not yet implemented"};CALC.AbstractCallException=function(){this.name="Abstract method call";this.message="The method is abstract"};CALC.Node=function(){};CALC.Node.prototype={constructor:CALC.Node,clone:function(){return this.constructor()},accept:function(a){return a.visitNode()}};(CALC.Operation=function(){}).inheritsFrom(CALC.Node);(CALC.Constant=function(a){a=a||{};this.value=a.value||0}).inheritsFrom(CALC.Node,{accept:function(a){return a.visitConstant(this)},toString:function(){return this.value},clone:function(){return new this.constructor({value:this.value})}});
(CALC.Variable=function(a){a=a||{};this.symbol=a.symbol||"x"}).inheritsFrom(CALC.Node,{accept:function(a){return a.visitVariable(this)},toString:function(){return this.symbol},clone:function(){return new this.constructor({symbol:this.symbol})}});(CALC.BinaryOperation=function(a){a=a||{};this.left=a.left||null;this.right=a.right||null}).inheritsFrom(CALC.Operation,{accept:function(a){return a.visitBinaryOperation(this)},clone:function(){return new this.constructor({left:this.left.clone(),right:this.right.clone()})}});
(CALC.UnaryOperation=function(a){a=a||{};this.arg=a.arg}).inheritsFrom(CALC.Operation,{clone:function(){return new this.constructor({arg:this.arg.clone()})}});(CALC.Power=function(a){a=a||{};this.left=a.left||new CALC.Constant({value:0});this.right=a.right||new CALC.Constant({value:1})}).inheritsFrom(CALC.BinaryOperation,{accept:function(a){return a.visitPower(this)},toString:function(){return"("+this.left.toString()+" ^ "+this.right.toString()+")"}});
(CALC.Multiplication=function(a){a=a||{};this.left=a.left||new CALC.Constant({value:1});this.right=a.right||new CALC.Constant({value:1})}).inheritsFrom(CALC.BinaryOperation,{accept:function(a){return a.visitMultiplication(this)},toString:function(){return"("+this.left.toString()+" * "+this.right.toString()+")"}});
(CALC.Division=function(a){a=a||{};this.left=a.left||new CALC.Constant({value:0});this.right=a.right||new CALC.Constant({value:1})}).inheritsFrom(CALC.BinaryOperation,{accept:function(a){return a.visitDivision(this)},toString:function(){return"("+this.left.toString()+" / "+this.right.toString()+")"}});
(CALC.Addition=function(a){a=a||{};this.left=a.left||new CALC.Constant({value:0});this.right=a.right||new CALC.Constant({value:0})}).inheritsFrom(CALC.BinaryOperation,{accept:function(a){return a.visitAddition(this)},toString:function(){return"("+this.left.toString()+" + "+this.right.toString()+")"}});
(CALC.Subtraction=function(a){a=a||{};this.left=a.left||new CALC.Constant({value:0});this.right=a.right||new CALC.Constant({value:0})}).inheritsFrom(CALC.BinaryOperation,{accept:function(a){return a.visitSubtraction(this)},toString:function(){return"("+this.left.toString()+" - "+this.right.toString()+")"}});
(CALC.Ln=function(a){a=a||{};this.arg=a.arg||new CALC.Constant({value:1})}).inheritsFrom(CALC.UnaryOperation,{accept:function(a){return a.visitLn(this)},toString:function(){return"ln("+this.arg.toString()+")"}});(CALC.Exp=function(a){a=a||{};this.arg=a.arg||new CALC.Constant({value:0})}).inheritsFrom(CALC.UnaryOperation,{accept:function(a){return a.visitExp(this)},toString:function(){return"e^("+this.arg.toString()+")"}});
(CALC.Sin=function(a){a=a||{};this.arg=a.arg||new CALC.Constant({value:0})}).inheritsFrom(CALC.UnaryOperation,{accept:function(a){return a.visitSin(this)},toString:function(){return"sin("+this.arg.toString()+")"}});(CALC.Cos=function(a){a=a||{};this.arg=a.arg||new CALC.Constant({value:0})}).inheritsFrom(CALC.UnaryOperation,{accept:function(a){return a.visitCos(this)},toString:function(){return"cos("+this.arg.toString()+")"}});(CALC.NodeVisitor=function(){}).extend({visitNode:function(){throw new CALC.AbstractCallException;},visitConstant:function(){throw new CALC.AbstractCallException;},visitOperation:function(){throw new CALC.AbstractCallException;},visitUnaryOperation:function(){throw new CALC.AbstractCallException;},visitBinaryOperation:function(){throw new CALC.AbstractCallException;},visitVariable:function(){throw new CALC.AbstractCallException;},visitAddition:function(a){return this.visitBinaryOperation(a)},visitSubtraction:function(a){return this.visitBinaryOperation(a)},
visitMultiplication:function(a){return this.visitBinaryOperation(a)},visitDivision:function(a){return this.visitBinaryOperation(a)},visitPower:function(a){return this.visitBinaryOperation(a)},visitExp:function(a){return this.visitUnaryOperation(a)},visitLn:function(a){return this.visitUnaryOperation(a)},visitSin:function(a){return this.visitUnaryOperation(a)},visitCos:function(a){return this.visitUnaryOperation(a)}});CALC.Node.extend({evaluate:function(a){return CALC.evaluate({node:this,variables:a})}});CALC.evaluate=function(a){return(new CALC.Evaluator(a)).evaluate()};
(CALC.Evaluator=function(a){a=a||{};this.node=a.node||null;this.variables=a.variables||{}}).inheritsFrom(CALC.NodeVisitor,{evaluate:function(){return this.node.accept(this)},visitConstant:function(a){return a.value},visitVariable:function(a){if("number"===typeof this.variables[a.symbol])return this.variables[a.symbol];console.log(this.variables);console.log(a);throw{name:"Missing variable",message:"Cannot evaluate expresison. "+a.symbol+" is "+this.variables[a.symbol]+"."};},visitAddition:function(a){return a.left.evaluate(this.variables)+
a.right.evaluate(this.variables)},visitSubtraction:function(a){return a.left.evaluate(this.variables)-a.right.evaluate(this.variables)},visitMultiplication:function(a){return a.left.evaluate(this.variables)*a.right.evaluate(this.variables)},visitDivision:function(a){var b=a.left.evaluate(this.variables);a=a.right.evaluate(this.variables);if(0===a)throw{name:"Division by zero",message:"Cannot evaluate expression, denominator is zero!"};return b/a},visitPower:function(a){return Math.pow(a.left.evaluate(this.variables),
a.right.evaluate(this.variables))},visitExp:function(a){return Math.exp(a.arg.evaluate(this.variables))},visitLn:function(a){return Math.log(a.arg.evaluate(this.variables))},visitSin:function(a){return Math.sin(a.arg.evaluate(this.variables))},visitCos:function(a){return Math.cos(a.arg.evaluate(this.variables))}});CALC.Node.extend({simplify:function(){return CALC.simplify({node:this})}});CALC.simplify=function(a){return(new CALC.Simplifier(a)).simplify()};
(CALC.Simplifier=function(a){a=a||{};this.node=a.node||null}).inheritsFrom(CALC.NodeVisitor,{simplify:function(){return this.node.accept(this)},visitConstant:function(a){return a.clone()},visitVariable:function(a){return a.clone()},visitAddition:function(a){var b=a.left.simplify(),c=a.right.simplify(),d=new CALC.Addition({left:b,right:c});return b instanceof CALC.Constant&&c instanceof CALC.Constant&&(a=d.evaluate(),a===Math.round(a))?new CALC.Constant({value:a}):b instanceof CALC.Constant&&!b.value?
c:c instanceof CALC.Constant&&!c.value?b:d},visitSubtraction:function(a){var b=a.left.simplify(),c=a.right.simplify(),d=new CALC.Subtraction({left:b,right:c});return b instanceof CALC.Constant&&c instanceof CALC.Constant&&(a=d.evaluate(),a===Math.round(a))?new CALC.Constant({value:a}):b instanceof CALC.Constant&&!b.value?new CALC.Multiplication({left:new CALC.Constant({value:-1}),right:c}):c instanceof CALC.Constant&&!c.value?b:d},visitMultiplication:function(a){var b=a.left.simplify(),c=a.right.simplify(),
d=new CALC.Multiplication({left:b,right:c});if(b instanceof CALC.Constant&&c instanceof CALC.Constant&&(a=d.evaluate(),a===Math.round(a)))return new CALC.Constant({value:a});if(b instanceof CALC.Constant){if(!b.value)return b;if(1===b.value)return c}if(c instanceof CALC.Constant){if(!c.value)return c;if(1===c.value)return b}return d},visitDivision:function(a){var b=a.left.simplify(),c=a.right.simplify(),d=new CALC.Division({left:b,right:c});if(b instanceof CALC.Constant&&c instanceof CALC.Constant&&
(a=d.evaluate(),a===Math.round(a)))return new CALC.Constant({value:a});if(b instanceof CALC.Constant){if(!b.value)return new CALC.Constant({value:0})}else if(c instanceof CALC.Constant&&1===c.value)return b;return d},visitPower:function(a){var b=a.left.simplify(),c=a.right.simplify(),d=new CALC.Power({left:b,right:c});if(b instanceof CALC.Constant&&c instanceof CALC.Constant&&(a=d.evaluate(),a===Math.round(a)))return new CALC.Constant({value:a});if(b instanceof CALC.Constant){if(!b.value)return new CALC.Constant({value:0})}else if(c instanceof
CALC.Constant&&1===c.value)return b;return d},visitExp:function(a){return a.clone()},visitLn:function(a){return a.clone()},visitSin:function(a){return a.clone()},visitCos:function(a){return a.clone()}});CALC.Node.extend({differentiate:function(a){return CALC.differentiate({node:this,symbol:a})}});CALC.differentiate=function(a){return(new CALC.Differentiator(a)).differentiate()};
(CALC.Differentiator=function(a){a=a||{};this.node=a.node||null;this.symbol=a.symbol||"x"}).inheritsFrom(CALC.NodeVisitor,{differentiate:function(){return this.node.accept(this).simplify()},visitConstant:function(){return new CALC.Constant({value:0})},visitVariable:function(a){return a.symbol===this.symbol?new CALC.Constant({value:1}):new CALC.Constant({value:0})},visitAddition:function(a){return new CALC.Addition({left:a.left.differentiate(this.symbol),right:a.right.differentiate(this.symbol)})},
visitSubtraction:function(a){return new CALC.Subtraction({left:a.left.differentiate(this.symbol),right:a.right.differentiate(this.symbol)})},visitMultiplication:function(a){return new CALC.Addition({left:new CALC.Multiplication({left:a.left.differentiate(this.symbol),right:a.right.clone()}),right:new CALC.Multiplication({left:a.left.clone(),right:a.right.differentiate(this.symbol)})})},visitDivision:function(a){return new CALC.Division({left:new CALC.Subtraction({left:new CALC.Multiplication({left:a.left.differentiate(this.symbol),
right:a.right.clone()}),right:new CALC.Multiplication({left:a.left.clone(),right:a.right.differentiate(this.symbol)})}),right:new CALC.Power({left:a.right.clone(),right:new CALC.Constant({value:2})})})},visitPower:function(a){return new CALC.Addition({left:new CALC.Multiplication({left:a.right.clone(),right:new CALC.Multiplication({left:new CALC.Power({left:a.left.clone(),right:new CALC.Subtraction({left:a.right.clone(),right:new CALC.Constant({value:1})})}),right:a.left.differentiate(this.symbol)})}),
right:new CALC.Multiplication({left:new CALC.Power({left:a.left.clone(),right:a.right.clone()}),right:new CALC.Multiplication({left:new CALC.Ln({arg:a.left.clone()}),right:a.right.differentiate(this.symbol)})})})},visitExp:function(a){return new CALC.Multiplication({left:a.arg.differentiate(this.symbol),right:a.clone()})},visitLn:function(a){return new CALC.Division({left:a.arg.differentiate(this.symbol),right:a.arg.clone()})},visitSin:function(a){return new CALC.Multiplication({left:a.arg.differentiate(this.symbol),
right:new CALC.Cos({arg:a.arg.clone()})})},visitCos:function(a){return new CALC.Multiplication({left:a.arg.differentiate(this.symbol),right:new CALC.Multiplication({left:new CALC.Constant({value:-1}),right:new CALC.Sin({arg:a.arg.clone()})})})}});CALC.Node.extend({replace:function(a){return CALC.replace({node:this,symbols:a})}});CALC.replace=function(a){return(new CALC.Replacer(a)).replace()};
(CALC.Replacer=function(a){a=a||{};this.node=a.node||null;this.symbols=a.symbols||{}}).inheritsFrom(CALC.NodeVisitor,{replace:function(){return this.node.accept(this)},visitConstant:function(a){return new CALC.Constant({value:a.value})},visitVariable:function(a){for(var b in this.symbols)if(this.symbols.hasOwnProperty(b)&&b===a.symbol){if("number"===typeof this.symbols[b])return new CALC.Constant({value:this.symbols[b]});if("string"===typeof this.symbols[b])return new CALC.Variable({symbol:this.symbols[b]});
throw new CALC.Exception("");}return a.clone()},visitUnaryOperation:function(a){return new a.constructor({arg:a.arg.replace(this.symbols)})},visitBinaryOperation:function(a){return new a.constructor({left:a.left.replace(this.symbols),right:a.right.replace(this.symbols)})}});CALC.mathML=function(a){return(new CALC.MathMLFormatter(a)).format()};CALC.Node.extend({mathML:function(){return CALC.mathML({node:this})},mathMLElement:function(){return $('<math style="font-size: 24px">'+CALC.mathML({node:this})+"</math>")}});
(CALC.MathMLFormatter=function(a){a=a||{};this.node=a.node||null}).inheritsFrom(CALC.NodeVisitor,{format:function(){return this.node.accept(this)},visitConstant:function(a){return"<mn>"+a.value+"</mn>"},visitVariable:function(a){return"<mi>"+a.symbol+"</mi>"},visitAddition:function(a){return a.left.mathML()+"<mo>+</mo>"+a.right.mathML()},visitSubtraction:function(a){return a.left.mathML()+"<mo>-</mo>"+a.right.mathML()},visitMultiplication:function(a){var b=a.left.mathML(),c=a.right.mathML();if(a.left instanceof
CALC.Addition||a.left instanceof CALC.Subtraction)b=this.parenthesize(b);if(a.right instanceof CALC.Addition||a.right instanceof CALC.Subtraction)c=this.parenthesize(c);return b+"<mo>&InvisibleTimes;</mo>"+c},visitDivision:function(a){return"<mfrac><mrow>"+a.left.mathML()+"</mrow><mrow>"+a.right.mathML()+"</mrow></mfrac>"},visitPower:function(a){var b=a.left instanceof CALC.Operation?this.parenthesize(a.left.mathML()):a.left.mathML();a=a.right instanceof CALC.Operation?this.parenthesize(a.right.mathML()):
a.right.mathML();return"<msup>"+b+a+"</msup>"},visitExp:function(a){return"<msup><mi>e</mi>"+a.right.mathML()+"</msup>"},visitLn:function(a){return"<mi>ln</mi>"+this.parenthesize(a.arg.mathML())},visitSin:function(a){return"<mi>sin</mi>"+this.parenthesize(a.arg.mathML())},visitCos:function(a){return"<mi>cos</mi>"+this.parenthesize(a.arg.mathML())},parenthesize:function(a){return'<mfenced open="(" close=")"><mrow>'+a+"</mrow></mfenced>"}});CALC.glslFormat=function(a){return(new CALC.GLSLFormatter(a)).format()};CALC.Node.extend({glsl:function(){return CALC.glslFormat({node:this})}});
(CALC.GLSLFormatter=function(a){a=a||{};this.node=a.node||null}).inheritsFrom(CALC.NodeVisitor,{format:function(){return this.node.accept(this)},visitConstant:function(a){a=a.value.toString();a.indexOf(".")===a.indexOf("e")&&(a+=".0");return a},visitVariable:function(a){return"parameter_"+a.symbol},visitAddition:function(a){return"("+a.left.glsl()+" + "+a.right.glsl()+")"},visitSubtraction:function(a){return"("+a.left.glsl()+" - "+a.right.glsl()+")"},visitMultiplication:function(a){return"("+a.left.glsl()+
"*"+a.right.glsl()+")"},visitDivision:function(a){return"("+a.left.glsl()+"/"+a.right.glsl()+")"},visitPower:function(a){return"pow("+a.left.glsl()+", "+a.right.glsl()+")"},visitExp:function(a){return"exp("+a.right.glsl()+")"},visitLn:function(a){return"log("+a.arg.glsl()+")"},visitSin:function(a){return"sin("+a.arg.glsl()+")"},visitCos:function(a){return"cos("+a.arg.glsl()+")"}});CALC.parse=function(a){return(new CALC.Parser(a)).parse()};CALC.Parser=function(a){this.str=a};
CALC.Parser.prototype.operators={"^":{precedence:4,Node:CALC.Power,requiresEsc:!0,args:2},"*":{precedence:5,Node:CALC.Multiplication,requiresEsc:!0,args:2},"/":{precedence:5,Node:CALC.Division,requiresEsc:!0,args:2},"+":{precedence:6,Node:CALC.Addition,requiresEsc:!0,args:2},"-":{precedence:6,Node:CALC.Subtraction,requiresEsc:!0,args:2},sin:{precedence:3,Node:CALC.Sin,requiresEsc:!1,args:1},cos:{precedence:3,Node:CALC.Cos,requiresEsc:!1,args:1},ln:{precedence:3,Node:CALC.Ln,requiresEsc:!1,args:1}};
CALC.Parser.extend({parse:function(){var a=this.infixToPostfix(this.tokenize());return this.buildExpressionTree(a)},tokenize:function(){var a,b,c,d,e;c=CALC.Parser.prototype.operators;d="(";for(b in c)c.hasOwnProperty(b)&&(d+=(c[b].requiresEsc?"\\":"")+b+"|");e=RegExp(d+"\\(|\\)|(\\d+(?:\\.\\d*)?(?:e[+\\-]?\\d+)?|[a-zA-Z]))","gi");return function(){for(var b=[];a=e.exec(this.str);)b.push(a[1]);return b}}(),infixToPostfix:function(a){var b,c=[],d=[],e;for(e="empty";b=a.shift();)if(this.operators[b]){if(2===
this.operators[b].args)for(e=c.length&&c[c.length-1];e&&"("!==e&&")"!==e&&this.operators[e].precedence<this.operators[b].precedence;)d.push(c.pop()),e=c.length&&c[c.length-1];c.push(b);e="operator"}else if("("===b)c.push(b),e="left-paranthesis";else if(")"===b){for(;c.length&&"("!==c[c.length-1];)d.push(c.pop());c.length&&c.pop();c.length&&(this.operators[c[c.length-1]]&&1===this.operators[c[c.length-1]].args)&&d.push(c.pop());e="right-paranthesis"}else{d.push(b);if("operand"===e||"right-paranthesis"===
e)console.log(b),d.push("*");e="operand"}for(;c.length;)a=c.pop(),"("!==a&&d.push(a);return d},buildExpressionTree:function(a){var b=[],c,d,e;for(c=0;c<a.length;c++)e=a[c],(d=this.operators[e])?2===d.args?b.push(new d.Node({right:b.pop(),left:b.pop()})):1===d.args&&b.push(new d.Node({arg:b.pop()})):(d=parseFloat(e),!e||d||0===d?b.push(new CALC.Constant({value:parseFloat(e)})):b.push(new CALC.Variable({symbol:e})));return b[0]}});CALC.Node.extend({tangentialPlane:function(a,b){return CALC.tangentialPlane(this,a,b)}});
CALC.tangentialPlane=function(a,b,c){var d,e,h;d=a.differentiate("x").evaluate({x:b,y:c});e=a.differentiate("y").evaluate({x:b,y:c});d=new THREE.Vector3(1,0,d);h=new THREE.Vector3(0,1,e);e=new THREE.Vector3;e.cross(d,h);a=-e.x*b-e.y*c-e.z*a.evaluate({x:b,y:c});return new CALC.Addition({left:new CALC.Addition({left:new CALC.Multiplication({left:new CALC.Constant({value:-e.x/e.z}),right:new CALC.Variable({symbol:"x"})}),right:new CALC.Multiplication({left:new CALC.Constant({value:-e.y/e.z}),right:new CALC.Variable({symbol:"y"})})}),
right:new CALC.Constant({value:-a/e.z})})};CALC.scheduler=function(){var a={},b=0,c=0,d=(new Date).getTime(),e={callback:null,frame:-1,next:null,id:++b};a.attach=function(a,d){var l=e,j=null,q=c+d;if(a){for(q=Math.min(q,c)+1;q>l.frame&&l.next;)l=l.next;j=l.next;l.next={callback:a,frame:q,next:j,id:++b};return l.next.id}};a.detach=function(a){for(var b=e;b.next&&b.next.id!==a;)b=b.next;return b.next?(b.next=b.next.next,!0):!1};a.tick=function(){for(;e.next&&e.next.frame<=c;)e.next.callback(),e.next=e.next.next;c++};a.frame=function(){return c};
a.millisecond=function(){return(new Date).getTime()-d};return a}();(CALC.Animation=function(a){void 0!==a.milliseconds?(this.duration=a.milliseconds,this.unit="milliseconds",this.endTime=this.startTime=0):(this.duration=a.frames||60,this.unit="frames",this.startTime=this.endTime=0);this.interpolation=a.interpolation||CALC.interpolations.linear;this.begin=a.begin;this.step=a.step;this.end=a.end||function(){};this.active=!1}).extend({proceed:function(){var a,b=this,c=CALC.scheduler;this.active&&(a="milliseconds"===b.unit?(c.millisecond()-this.startTime)/(this.endTime-
this.startTime):(c.frame()-this.startTime)/(this.endTime-this.startTime),this.makeFrame(a),1>a?c.attach(function(){b.proceed()},0):(this.active=!1,this.end()))},makeFrame:function(a){1<a&&(a=1);0>a&&(a=0);a=this.interpolation(a);this.step(a)},start:function(){var a=this,b=CALC.scheduler;this.active=!0;this.startTime="milliseconds"===this.unit?b.millisecond():b.frame();this.endTime=this.startTime+this.duration;this.begin();b.attach(function(){a.proceed()},0)},abort:function(){this.active=!1},skip:function(){this.makeFrame(1);
this.abort()},revert:function(){this.makeFrame(0);this.abort()}});CALC.animator=function(){var a={animate:function(a){a=new CALC.Animation(a);a.start();return a},animateProperties:function(b){var c=b.object,d=Object.keys(b.parameters),e={},h=b.parameters,f=b.beforeStep||function(){},l=b.afterStep||function(){};return a.animate({frames:b.frames,milliseconds:b.milliseconds,interpolation:b.interpolation,begin:function(){d.forEach(function(a){e[a]=c[a]})},step:function(a){f();d.forEach(function(b){var d=e[b];c[b]=d+(h[b]-d)*a});l()},end:b.end})}};return a}();CALC.interpolations={linear:function(a){return a},sinusodial:function(a){return(Math.sin((a-0.5)*Math.PI)+1)/2},cubic:function(a){return(3-2*a)*a*a},quintic:function(a){return(6*a*a-15*a+10)*a*a*a},easeOut:function(a){return(a-1)*(1-a)+1}};CALC.mouseHandler=function(){var a={},b=[],c=[],d,e=[];a.mouseDown=function(a,c){var l=c.which;c.stopPropagation();c.preventDefault();e.push({x:c.clientX,y:c.clientY});d=a;b[l]=!0;d.mouseDown(c)};a.mouseUp=function(a,f){var l=f.which;f.stopPropagation();f.preventDefault();c[l]||d.click(f);b[l]=c[l]=!1;e=[];d.mouseUp(f)};a.mouseMove=function(a,f){var l=f.which;f.stopPropagation();f.preventDefault();c[l]=b[l];c[l]?(e.push({x:f.clientX,y:f.clientY}),d.drag(f,e)):d=a;d.mouseMove(f)};a.mouseWheel=function(a,
b,c){b.stopPropagation();b.preventDefault();d.scroll(b,c)};a.touchStart=function(a,b){e=[];b.stopPropagation();b.preventDefault()};a.touchEnd=function(a,b){b.preventDefault();e=[]};a.touchMove=function(a,b){b.stopPropagation();b.preventDefault();1===b.touches.length&&(e.push({x:b.touches[0].pageX,y:b.touches[0].pageY}),d.drag(b,e))};return a}();(CALC.MouseStrategy=function(a){this.renderer=a}).extend({mouseDown:function(){},mouseMove:function(){},mouseUp:function(){},mouseWheel:function(){},touchStart:function(){},touchEnd:function(){},touchMove:function(){},click:function(){},drag:function(){},scroll:function(){}});(CALC.NavigationStrategy=function(a,b){this.renderer=a;this.branch=b}).inheritsFrom(CALC.MouseStrategy,{drag:function(a,b){if(1==a.which){var c=b.length,d;2<=c&&(d=b[c-1].x-b[c-2].x,c=b[c-1].y-b[c-2].y,this.branch.rotation.z+=0.01*d,this.branch.rotation.x+=0.01*c,this.branch.rotation.x>Math.PI/2?this.branch.rotation.x=Math.PI/2:this.branch.rotation.x<-Math.PI/2&&(this.branch.rotation.x=-Math.PI/2))}else 3==a.which&&(c=b.length,2<=c&&(d=b[c-1].x-b[c-2].x,c=b[c-1].y-b[c-2].y,this.branch.position.x+=
0.05*d,this.branch.position.z-=0.05*c))},scroll:function(a,b){this.renderer.camera.zoom(5*b)}});CALC.ScreenCamera=function(a,b,c,d){THREE.Camera.call(this);this.fov=void 0!==a?a:50;this.aspect=void 0!==b?b:1;this.near=void 0!==c?c:0.1;this.far=void 0!==d?d:2E3;this.updateProjectionMatrix()};CALC.ScreenCamera.prototype=new THREE.Camera;CALC.ScreenCamera.prototype.constructor=CALC.ScreenCamera;CALC.ScreenCamera.prototype.setLens=function(a,b){this.fov=2*Math.atan((void 0!==b?b:24)/(2*a))*(180/Math.PI);this.updateProjectionMatrix()};
CALC.ScreenCamera.prototype.setViewOffset=function(a,b,c,d,e,h){this.fullWidth=a;this.fullHeight=b;this.x=c;this.y=d;this.width=e;this.height=h;this.updateProjectionMatrix()};
CALC.ScreenCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var a=this.fullWidth/this.fullHeight,b=Math.tan(this.fov*Math.PI/360)*this.near,c=-b,d=a*c,a=Math.abs(a*b-d),c=Math.abs(b-c);this.projectionMatrix=THREE.Matrix4.makeFrustum(d+this.x*a/this.fullWidth,d+(this.x+this.width)*a/this.fullWidth,b-(this.y+this.height)*c/this.fullHeight,b-this.y*c/this.fullHeight,this.near,this.far)}else this.projectionMatrix=THREE.Matrix4.makePerspective(this.fov,this.aspect,this.near,this.far)};CALC.Camera=function(a,b,c,d,e,h,f,l,j,q){THREE.Camera.call(this);this.left=a||-1200;this.right=b||1200;this.top=c||300;this.bottom=d||-300;this.near=void 0!==e?e:0.1;this.far=void 0!==h?h:2E3;this.fov=void 0!==f?f:53.14;this.aspect=void 0!==l?l:1;this.focusDistance=void 0!==j?j:20;this.perspectiveMatrix=new THREE.Matrix4;this.orthographicMatrix=new THREE.Matrix4;this.perspective=void 0!==q?q:1;this.updateProjectionMatrix()};CALC.Camera.prototype=new THREE.Camera;
CALC.Camera.prototype.constructor=CALC.Camera;CALC.Camera.prototype.zoom=function(a,b){this.fov=b?45-a:this.fov-a;this.fov=5>this.fov?5:175<this.fov?175:this.fov;this.updateProjectionMatrix();return this};CALC.Camera.prototype.getZoom=function(){return-this.fov+45};
CALC.Camera.prototype.updateProjectionMatrix=function(){this.perspectiveMatrix.makePerspective(this.fov,this.aspect,this.near,this.far);this.top=Math.tan(Math.PI/360*this.fov)*this.focusDistance;this.bottom=-this.top;this.left=this.aspect*this.bottom;this.right=this.aspect*this.top;this.orthographicMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far);var a=this.perspective/(1.05-this.perspective)/20;this.perspectiveMatrix.multiplyScalar(a);this.orthographicMatrix.multiplyScalar(1-
a);te=this.projectionMatrix.elements;pe=this.perspectiveMatrix.elements;oe=this.orthographicMatrix.elements;for(a=0;16>a;a++)te[a]=pe[a]+oe[a]};(CALC.VectorArrow=function(a,b,c,d){THREE.Object3D.call(this);this.xlen=a;this.ylen=b;this.zlen=c;"number"===typeof a&&(this.xlen=new CALC.Constant({value:a}));"number"===typeof b&&(this.ylen=new CALC.Constant({value:b}));"number"===typeof c&&(this.zlen=new CALC.Constant({value:c}));this._oldZ=this._oldY=this._oldX=0;a={opacity:{type:"f",value:1},len:{type:"f",value:1},size:{type:"f",value:0.02},color:{type:"c",value:new THREE.Color(d)}};this.cylMaterial=new THREE.ShaderMaterial({uniforms:a,vertexShader:"varying vec3 pos;\nvarying vec3 n;\nuniform float size;\nuniform float len;\nvarying vec3 vColor;\nuniform vec3 color;\nvoid main() {\npos = position;\nn = normal;\nvec4 mvPosition = modelViewMatrix * vec4( size*position.x, step(0.00001, position.y)*(position.y*len-6.0*size), size*position.z, 1.0 );\nvColor = color;\ngl_Position = projectionMatrix * mvPosition;\n}",
fragmentShader:"varying vec3 pos;\nvarying vec3 n;\nuniform vec3 color;\nvec3 applyLight(vec3 color, float intensity, vec3 direction, vec3 normal) {\nvec3 diffuse = intensity * (color * clamp(dot(normalize(direction), normal), 0.0, 1.0));\nreturn diffuse;\n}\nvoid main() {\nfloat a = (pos.z + 1.0)/2.0;\nvec3 component1 = (applyLight(vec3(1.0, 1.0, 1.0), 0.3, vec3(-1.0, -1.0, -0.4), n));\nvec3 component2 = (applyLight(vec3(1.0, 1.0, 1.0), 0.3, vec3(1.0, 1.0, -0.4), n));\nvec3 ambient = vec3(0.5, 0.5, 0.5);\ngl_FragColor = vec4(color * (ambient + component1 + component2), 1.0);\n}"});
this.coneMaterial=new THREE.ShaderMaterial({uniforms:a,vertexShader:"varying vec3 pos;\nvarying vec3 n;\nuniform float size;\nvarying vec3 vColor;\nvoid main() {\npos = position;\nn = normal;\nvec4 mvPosition = modelViewMatrix * vec4( size*3.0*position.x, size*6.0*position.y, size*3.0*position.z, 1.0 );\nvColor = vec3(1.0, 0.0, 0.0);\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"varying vec3 pos;\nvarying vec3 n;\nuniform vec3 color;\nvec3 applyLight(vec3 color, float intensity, vec3 direction, vec3 normal) {\nvec3 diffuse = intensity * (color * clamp(dot(normalize(direction), normal), 0.0, 1.0));\nreturn diffuse;\n}\nvoid main() {\nfloat a = (pos.z + 1.0)/2.0;\nvec3 component1 = (applyLight(vec3(1.0, 1.0, 1.0), 0.3, vec3(-1.0, -1.0, -0.4), n));\nvec3 component2 = (applyLight(vec3(1.0, 1.0, 1.0), 0.3, vec3(1.0, 1.0, -0.4), n));\nvec3 ambient = vec3(0.5, 0.5, 0.5);\ngl_FragColor = vec4(color * (ambient + component1 + component2), 1.0);\n}"});
a=new THREE.CylinderGeometry(1,1,1,10,1);b=new THREE.CylinderGeometry(0,1,1,10,1);c=0;for(d=a.vertices.length;c<d;c++)a.vertices[c].y+=0.5;c=0;for(d=b.vertices.length;c<d;c++)b.vertices[c].y-=0.5;this.cyl=new THREE.Mesh(a,this.cylMaterial);this.cone=new THREE.Mesh(b,this.coneMaterial);this.zRotation=new THREE.Object3D;this.xRotation=new THREE.Object3D;this.xRotation.add(this.cone);this.xRotation.add(this.cyl);this.zRotation.add(this.xRotation);this.add(this.zRotation);this.prepareFrame(null,!0)}).inheritsFrom(THREE.Object3D,
{prepareFrame:function(a,b){var c,d,e,h,f;if(b||this._oldX!==this.position.x||this._oldY!==this.position.y||this._oldZ!==this.position.z)c=this.position.x,d=this.position.y,e=this.position.z,h=this.xlen.evaluate({x:c,y:d,z:e}),f=this.ylen.evaluate({x:c,y:d,z:e}),d=this.zlen.evaluate({x:c,y:d,z:e}),c=Math.sqrt(h*h+f*f+d*d),this.cone.position.set(0,c,0),d=0===d?0:Math.atan2(d,h),h=0===h?Math.PI/2:Math.atan2(f,h),this.zRotation.rotation.set(0,0,h-Math.PI/2),this.xRotation.rotation.set(d,0,0),this.cylMaterial.uniforms.len.value=
c,this._oldX=this.position.x,this._oldY=this.position.y,this._oldZ=this.position.z}});(CALC.MultiSortObject=function(a,b){var c,d,e;if(a||b)if(THREE.Object3D.call(this),this.meshes=[],a&&b){d=a.length;for(c=0;c<d;c++)e=new THREE.Mesh(a[c],b),e.doubleSided=!0,this.meshes.push(e);this.material=b;this.currentIndex=0;this.currentChild=this.meshes[0];this.add(this.meshes[0])}}).inheritsFrom(THREE.Object3D,{getBoundingBox:function(){var a=this.meshes[0].geometry;a.boundingBox||a.computeBoundingBox();return a.boundingBox},replaceMesh:function(a){this.currentIndex!==a&&(this.remove(this.currentChild),
this.currentIndex=a,this.currentChild=this.meshes[a],this.add(this.currentChild))},replaceMaterial:function(a){var b;g=0;for(b=this.meshes.length;g<b;g++)this.meshes[g].material=a},prepareFrame:function(a){a=a.camera;var b;this.updateMatrix();this.updateMatrixWorld();a.updateMatrix();a.updateMatrixWorld();a=a.matrixWorld.getPosition().clone();b=new THREE.Matrix4;b.getInverse(this.matrixWorld);a=b.multiplyVector3(a);this.replaceMesh(Math.abs(a.x)>Math.abs(a.y)?Math.abs(a.x)>Math.abs(a.z)?0<a.x?0:3:
0<a.z?2:5:Math.abs(a.y)>Math.abs(a.z)?0<a.y?1:4:0<a.z?2:5)}});(CALC.Label3D=function(a,b,c,d){a&&(THREE.Object3D.call(this),this.domElement=$('<div class="label3D"></div>'),this.domElement.append(b),this.domX=-1,this.domY=0,this.leftOffset=c||0,this.topOffset=d||0,$(a.domElement).parent().append(this.domElement),this.opacity=0.6,this.domElement.css({opacity:this.opacity/2}).hover(function(){$(this).css("opacity",this.opacity)},function(){$(this).css("opacity",this.opacity/2)}),this.projector=new THREE.Projector)}).inheritsFrom(THREE.Object3D,{setOpacity:function(a){this.opacity=
a;this.domElement.css("opacity",this.opacity);0.0010>this.opacity?this.domElement.css("display","none"):this.domElement.css("display","block")},detach:function(){this.domElement.remove()},prepareFrame:function(a,b){var c=a.camera,d,e;c.updateMatrix();c.updateMatrixWorld();this.updateMatrix();this.updateMatrixWorld();c=this.projector.projectVector(this.matrixWorld.getPosition(),c);if(b||c.x!==this.domX||c.y!==this.domY)d=$(a.domElement),e=d.innerHeight(),d=d.innerWidth(),this.domX=c.x,this.domY=c.y,
1<this.domX||-1>this.domX||1<this.domY||-1>this.domY?this.domElement.css({visibility:"hidden"}):this.domElement.css({visibility:"visible"}),d=d/2*(1+c.x),c=e/2*(1-c.y),this.domElement.css({left:d+this.leftOffset,top:c+this.topOffset})}});(CALC.AxisLabel3D=function(a,b,c,d){THREE.Object3D.call(this);this.domElement=$('<div class="axisLabel3D"></div>');this.domElement.append(b);this.domX=-1;this.domY=0;this.leftOffset=c||0;this.topOffset=d||0;$(a.domElement).parent().append(this.domElement);this.domElement.css({opacity:0.6}).hover(function(){$(this).css("opacity",1)},function(){$(this).css("opacity",0.6)});this.projector=new THREE.Projector}).inheritsFrom(CALC.Label3D,{});(CALC.Button3D=function(a,b,c,d,e){THREE.Object3D.call(this);var h=this;this.enabled=!0;this.domElement=$('<div class="button3D"></div>');this.domElement.append(b);this.domElement.click(function(){h.enabled&&c()});this.domElement.hover(function(){h.enabled&&d()},function(){h.enabled&&e()});this.domX=-1;this.domY=0;this.topOffset=this.leftOffset=-6;$(a.domElement).parent().append(this.domElement);this.domElement.css({opacity:0.4}).hover(function(){h.enabled&&$(this).css("opacity",1)},function(){h.enabled&&
$(this).css("opacity",0.4)});this.projector=new THREE.Projector}).inheritsFrom(CALC.Label3D,{setEnabled:function(a){this.enabled=a}});CALC.buildFunctionSurface=function(a,b,c,d){var e=new CALC.Variable({symbol:"x"}),h=new CALC.Variable({symbol:"y"});return CALC.buildParametricSurface(e,h,a,{x:[b[0],b[2]],y:[b[1],b[3]]},null,c,d)};
CALC.buildParametricSurface=function(a,b,c,d,e,h,f){this.xExpr=a;this.yExpr=b;this.zExpr=c;var l,j=null;h=h||10;if(a&&b&&c&&d){e=[];for(p in d)d.hasOwnProperty(p)&&e.push(p);if(2!=e.length)throw new CALC.InvalidArgumentException;b=a=h;c=e[0];var q=e[1],n={},m=function(a){var b=a.x,c=a.y;a=a.z;j?(b<j.min.x?j.min.x=b:b>j.max.x&&(j.max.x=b),c<j.min.y?j.min.y=c:c>j.max.y&&(j.max.y=c),a<j.min.z?j.min.z=a:a>j.max.z&&(j.max.z=a)):j={min:new THREE.Vector3(b,c,a),max:new THREE.Vector3(b,c,a)}};h=[];var t,
x,w,r,u,s,C,A,v,E,F,B;for(e=d[c][0];e<d[c][1];e+=a)for(l=d[q][0];l<d[q][1];l+=b)t=[],n[c]=e,n[q]=l,x=this.xExpr.evaluate(n),s=this.yExpr.evaluate(n),v=this.zExpr.evaluate(n),n[c]=e+a,w=this.xExpr.evaluate(n),y1=this.yExpr.evaluate(n),E=this.zExpr.evaluate(n),n[q]=l+b,r=this.xExpr.evaluate(n),C=this.yExpr.evaluate(n),F=this.zExpr.evaluate(n),n[c]=e,u=this.xExpr.evaluate(n),A=this.yExpr.evaluate(n),B=this.zExpr.evaluate(n),x=new THREE.Vector3(x,s,v),m(x),t.push(new THREE.Vertex(x)),w=new THREE.Vector3(w,
y1,E),m(w),t.push(new THREE.Vertex(w)),r=new THREE.Vector3(r,C,F),m(r),t.push(new THREE.Vertex(r)),u=new THREE.Vector3(u,A,B),m(u),t.push(new THREE.Vertex(u)),h.push(t);d=h.slice(0);a=h.slice(0);facesZasc=h.slice(0);var y=function(a,b,c){return a[0].position[c]===b[0].position[c]?0:a[0].position[c]<b[0].position[c]?-1:1};d.sort(function(a,b){return y(a,b,"x")});a.sort(function(a,b){return y(a,b,"y")});facesZasc.sort(function(a,b){return y(a,b,"z")});h=d.slice(0).reverse();b=a.slice(0).reverse();c=
facesZasc.slice(0).reverse();e=function(a,b){var c,d=b.length;for(c=0;c<d;c++)a.vertices.push(b[c][0]),a.vertices.push(b[c][1]),a.vertices.push(b[c][2]),a.vertices.push(b[c][3]),a.faces.push(new THREE.Face4(4*c,4*c+1,4*c+2,4*c+3)),a.boundingBox=j;a.mergeVertices();a.computeCentroids()};l=new THREE.Geometry;q=new THREE.Geometry;n=new THREE.Geometry;m=new THREE.Geometry;t=new THREE.Geometry;u=new THREE.Geometry;e(l,d);e(q,a);e(n,facesZasc);e(m,h);e(t,b);e(u,c);return new CALC.MultiSortObject([l,q,n,
m,t,u],f)}};CALC.ParametricCurveGeometry=function(a,b,c,d,e,h){THREE.Geometry.call(this);this.xExpr=a;this.yExpr=b;this.zExpr=c;this.materials=[];h=h||1;if(a&&b&&c&&d){var f;for(p in d)if(d.hasOwnProperty(p)){f=p;break}for(a=d[f][0];a<d[f][1];a+=h)e={},e[f]=a,b=this.xExpr.evaluate(e),c=this.yExpr.evaluate(e),e=this.zExpr.evaluate(e),this.vertices.push(new THREE.Vertex(new THREE.Vector3(b,c,e)));e={};e[f]=d[f][1];b=this.xExpr.evaluate(e);c=this.yExpr.evaluate(e);e=this.zExpr.evaluate(e);this.vertices.push(new THREE.Vertex(new THREE.Vector3(b,
c,e)))}};CALC.ParametricCurveGeometry.prototype=new THREE.Geometry;CALC.ParametricCurveGeometry.prototype.constructor=CALC.ParametricCurveGeometry;CALC.ParametricSurfaceGeometry=function(a,b,c,d,e,h){THREE.Geometry.call(this);this.xExpr=a;this.yExpr=b;this.zExpr=c;var f=this,l;this.materials=[];h=h||10;if(a&&b&&c&&d){e=[];for(p in d)d.hasOwnProperty(p)&&e.push(p);if(2!=e.length)throw new CALC.InvalidArgumentException;a=h;b=0;c=e[0];var j=e[1],q={},n=function(a){var b=a.x,c=a.y;a=a.z;f.boundingBox?(b<f.boundingBox.min.x?f.boundingBox.min.x=b:b>f.boundingBox.max.x&&(f.boundingBox.max.x=b),c<f.boundingBox.min.y?f.boundingBox.min.y=c:c>f.boundingBox.max.y&&
(f.boundingBox.max.y=c),a<f.boundingBox.min.z?f.boundingBox.min.z=a:a>f.boundingBox.max.z&&(f.boundingBox.max.z=a)):f.boundingBox={min:new THREE.Vector3(b,c,a),max:new THREE.Vector3(b,c,a)}};for(e=d[c][0];e<d[c][1];e+=a)for(l=d[j][0];l<d[j][1];l+=h){q[c]=e;q[j]=l;var m=this.xExpr.evaluate(q),t=this.yExpr.evaluate(q),x=this.zExpr.evaluate(q);q[c]=e+a;var w=this.xExpr.evaluate(q),r=this.yExpr.evaluate(q),u=this.zExpr.evaluate(q);q[j]=l+h;var s=this.xExpr.evaluate(q),C=this.yExpr.evaluate(q),A=this.zExpr.evaluate(q);
q[c]=e;var v=this.xExpr.evaluate(q),E=this.yExpr.evaluate(q),F=this.zExpr.evaluate(q),m=new THREE.Vector3(m,t,x);n(m);f.vertices.push(new THREE.Vertex(m));w=new THREE.Vector3(w,r,u);n(w);f.vertices.push(new THREE.Vertex(w));s=new THREE.Vector3(s,C,A);n(s);f.vertices.push(new THREE.Vertex(s));v=new THREE.Vector3(v,E,F);n(v);f.vertices.push(new THREE.Vertex(v));v=new THREE.Face4(4*b,4*b+1,4*b+2,4*b+3);f.faces.push(v);b++}f.mergeVertices();f.computeCentroids();f.computeFaceNormals();f.computeVertexNormals();
this.facesXasc=f.faces.slice(0);this.facesYasc=f.faces.slice(0);this.facesZasc=f.faces.slice(0);this.computeCentroids();this.mergeVertices();var B=function(a,b,c){return k=a.centroid[c]===b.centroid[c]?0:a.centroid[c]<b.centroid[c]?-1:1};this.facesXasc.sort(function(a,b){return B(a,b,"x")});this.facesYasc.sort(function(a,b){return B(a,b,"y")});this.facesZasc.sort(function(a,b){return B(a,b,"z")});this.facesXdesc=f.facesXasc.slice(0).reverse().slice(0,0);this.facesYdesc=f.facesYasc.slice(0).reverse().slice(0,
500);this.facesZdesc=f.facesZasc.slice(0).reverse().slice(0,1E3);this.facesXasc=f.facesXasc.slice(0,0);this.facesYasc=f.facesYasc.slice(0,500);this.facesZasc=f.facesZasc.slice(0,1E3)}};CALC.ParametricSurfaceGeometry.prototype=new THREE.Geometry;CALC.ParametricSurfaceGeometry.prototype.constructor=CALC.ParametricSurfaceGeometry;CALC.FunctionSurfaceGeometry=function(a,b,c){var d=new CALC.Variable({symbol:"x"}),e=new CALC.Variable({symbol:"y"});CALC.ParametricSurfaceGeometry.call(this,d,e,a,{x:[b[0],b[2]],y:[b[1],b[3]]},null,c);this.computeCentroids();this.mergeVertices()};CALC.FunctionSurfaceGeometry.prototype=new CALC.ParametricSurfaceGeometry;CALC.FunctionSurfaceGeometry.prototype.constructor=CALC.FunctionSurfaceGeometry;(CALC.ParametricSurface=function(a){function b(a,b,c){var d=h.vertices;return d[a[0]][c]===d[b[0]][c]?0:d[a[0]][c]<d[b[0]][c]?-1:1}var c,d,e,h=this,f,l,j;if(a){c=a.domain;d=a.resolution;this.vertices=[];this.faces=[];this.vertexAttributes=[];this.extremes={};this.xExpr=a.x;this.yExpr=a.y;this.zExpr=a.z;this.attributes=a.attributes;this.constraints=a.constraints;this.appearance=a.appearance;e=Object.keys(c);if(2!==e.length)throw new CALC.InvalidArgumentException;a=e[0];e=e[1];"number"===typeof d?f=
d:(f=d[a]||10,d=d[e]||10);l=Math.ceil((c[a][1]-c[a][0])/f);j=Math.ceil((c[e][1]-c[e][0])/d);var q,n,m={};for(q=0;q<l;q++){m[a]=c[a][0]+f*q;for(n=0;n<j;n++)m[e]=c[e][0]+d*n,h.generateAttributes(m);m[e]=c[e][1];h.generateAttributes(m)}m[a]=c[a][1];for(n=0;n<j;n++)m[e]=c[e][0]+d*n,h.generateAttributes(m);m[e]=c[e][1];h.generateAttributes(m);for(q=0;q<l;q++)for(n=0;n<j;n++)h.faces.push([q*(j+1)+n,q*(j+1)+n+1,(q+1)*(j+1)+n+1,(q+1)*(j+1)+n]);c=[h.faces.slice(0).sort(function(a,c){return b(a,c,0)}),h.faces.slice(0).sort(function(a,
c){return b(a,c,1)}),h.faces.slice(0).sort(function(a,c){return b(a,c,2)})];for(a=0;3>a;a++)c.push(c[a].slice(0).reverse());a=[];for(e=0;6>e;e++){var t=new THREE.Geometry;f=c[e];h.vertices.forEach(function(a){t.vertices.push(new THREE.Vector3(a[0],a[1],a[2]))});f.forEach(function(a){t.faces.push(new THREE.Face4(a[0],a[1],a[2],a[3]))});t.computeCentroids();t.computeFaceNormals();t.computeVertexNormals();a[e]=t}c=new CALC.SurfaceMaterial({extremes:this.extremes,uniforms:this.uniforms,attributes:this.vertexAttributes,
constraints:this.constraints,appearance:this.appearance});CALC.MultiSortObject.call(this,a,c)}}).inheritsFrom(CALC.MultiSortObject,{generateAttributes:function(a){var b={},c=this;Object.keys(a).forEach(function(c){b[c]=a[c]});b.x=this.xExpr.evaluate(a);b.y=this.yExpr.evaluate(a);b.z=this.zExpr.evaluate(a);Object.keys(this.attributes).forEach(function(a){b[a]=c.attributes[a].evaluate(b)});this.vertices.push([b.x,b.y,b.z]);Object.keys(b).forEach(function(a){c.vertexAttributes[a]||(c.vertexAttributes[a]=
[]);c.vertexAttributes[a].push(b[a])});this.updateExtremes(b,this.extremes)},updateExtremes:function(a,b){0===Object.keys(this.extremes).length?Object.keys(a).forEach(function(c){var d=a[c];b[c]=[];b[c][0]=d;b[c][1]=d}):Object.keys(a).forEach(function(c){var d=a[c];d<b[c][0]?b[c][0]=d:d>b[c][1]&&(b[c][1]=d)})},setAppearance:function(a){this.material.setAppearance(a)},setUniform:function(a,b){this.material.uniforms[a].value=b},animate:function(a){var b=this.material,c=b.uniforms,d=[],e={},h={},f=this.material.checkerOpacity();
a.constraints&&Object.keys(a.constraints).forEach(function(c){var e=a.constraints[c];Object.keys(e).forEach(function(a){var f=e[a],m;"lower"===a?m=b.lowerConstraint(c):"upper"===a?m=b.upperConstraint(c):"lowerFeather"===a?m=b.lowerFeather(c):"upperFeather"===a&&(m=b.upperFeather(c));d.push(m);h[m]=f})});void 0!==a.checkerOpacity&&(h[f]=a.checkerOpacity,d.push(f));return CALC.animator.animate({frames:a.frames,milliseconds:a.milliseconds,interpolation:a.interpolation,begin:function(){d.forEach(function(a){e[a]=
c[a].value});void 0!==a.checkerOpacity&&(e[f]=c[f].value)},step:function(a){d.forEach(function(b){var d=e[b],f=h[b];void 0===f&&console.log(b);c[b].value=d+(f-d)*a})},end:a.end})},setUniforms:function(a){Object.keys(a).forEach(function(b){this.setUniform(b,a[b])})}});(CALC.FunctionSurface=function(a){var b={};if(a){b.x=new CALC.Variable({symbol:"x"});b.y=new CALC.Variable({symbol:"y"});b.z=new CALC.Variable({symbol:"z"});var c=a.z?"z":a.y?"y":a.x?"x":!1;if(c)b[c]=a[c];else throw new InvalidArgumentException;b.domain=a.domain;b.attributes=a.attributes;b.uniforms=a.uniforms;b.resolution=a.resolution;b.appearance=a.appearance;b.constraints=a.constraints;CALC.ParametricSurface.call(this,b)}}).inheritsFrom(CALC.ParametricSurface);(CALC.Color=function(a,b,c,d){void 0===d&&(d=255);this.r=a;this.g=b;this.b=c;this.a=d}).extend({hex:function(){return this.r/255<<16+this.g/255<<8/255+this.b},rgb:function(){return[this.r/255,this.g/255,this.b/255]},rgba:function(){return[this.r/255,this.g/255,this.b/255,this.a/255]},glslLiteral:function(){var a=this.rgba();return"vec4(float( "+a[0]+"), float( "+a[1]+"), float( "+a[2]+"), float( "+a[3]+"))"}});CALC.CheckerPattern=function(a){var b=[],c=a.color,d=a.opacity;delete a.color;delete a.opacity;Object.keys(a).forEach(function(c){var d,f;d=a[c];"color"!==d&&("number"===typeof d?(f=d,d=0):(f=d.distance||1,d=d.offset||0),b.push({parameter:c,distance:f,offset:d}))});this.forEachParameter=function(a){Object.keys(b).forEach(function(c){c=b[c];a(c.parameter,c.distance,c.offset)})};this.color=function(){return c};this.opacity=function(){return d}};CALC.ColorGradient=function(a){var b=[],c=0;delete a.mode;Object.keys(a).forEach(function(d){var e=a[d],e=e instanceof CALC.Color?e:new CALC.Color(e);b.push([d,e]);c++});b.sort(function(a,b){return a[0]-b[0]});this.getColor=function(a){return b[a][1]};this.getPosition=function(a){return b[a][0]};this.count=function(){return c};this.forEachColor=function(a){Object.keys(b).forEach(function(c){c=b[c];a(c[0],c[1])})}};(CALC.SurfaceMaterial=function(a){var b=this;this.appearance=a.appearance;this.parameters=Object.keys(a.attributes);this.constraints=a.constraints;this.extremes=a.extremes;this.attributes=[];this.uniforms=[];console.log(b);this.parameters.forEach(function(a){var c=b.constraints[a],d=b.extremes[a];c||(c={});var e=void 0!==c.lower?c.lower:d[0]-1,d=void 0!==c.upper?c.upper:d[1]+1,q=void 0!==c.lowerFeather?c.lowerFeather:0,c=void 0!==c.upperFeather?c.upperFeather:0;b.uniforms[b.lowerConstraint(a)]={type:"f",
value:e};b.uniforms[b.upperConstraint(a)]={type:"f",value:d};b.uniforms[b.lowerFeather(a)]={type:"f",value:q};b.uniforms[b.upperFeather(a)]={type:"f",value:c}});Object.keys(a.attributes).forEach(function(c){b.attributes[b.attributeParameter(c)]={type:"f",value:a.attributes[c]}});var c=this.appearance.colorGradient,d=this.appearance.colorGradientParameter,e=this.appearance.checkerPattern;this.colorGradient=c instanceof CALC.ColorGradient?c:new CALC.ColorGradient(c);this.colorGradientParameter=d;this.checkerPattern=
e instanceof CALC.CheckerPattern?e:new CALC.CheckerPattern(e);b.uniforms[b.checkerOpacity()]={type:"f",value:this.checkerPattern.opacity()};c=this.generateFragmentShader();d=this.generateVertexShader();THREE.ShaderMaterial.call(this,{fragmentShader:c,vertexShader:d,uniforms:this.uniforms,attributes:this.attributes,alphaTest:1,depthTest:!0})}).inheritsFrom(THREE.ShaderMaterial,{min:function(a){return"uMin_"+a},max:function(a){return"uMax_"+a},upperConstraint:function(a){return"uUpper_"+a},lowerConstraint:function(a){return"uLower_"+
a},upperFeather:function(a){return"uFeatherLower_"+a},lowerFeather:function(a){return"uFeatherUpper_"+a},checkerColor:function(){return"uCheckerColor"},checkerOpacity:function(){return"uCheckerOpacity"},attributeParameter:function(a){return"aParameter_"+a},varyingParameter:function(a){return"vParameter_"+a},glslUniformDefinitions:function(){var a=this,b="",b=b+("uniform float "+this.checkerColor()+";\n"),b=b+("uniform float "+this.checkerOpacity()+";\n");Object.keys(this.parameters).forEach(function(c){c=
a.parameters[c];b+="uniform float "+a.min(c)+";\n";b+="uniform float "+a.max(c)+";\n";b+="uniform float "+a.upperConstraint(c)+";\n";b+="uniform float "+a.lowerConstraint(c)+";\n";b+="uniform float "+a.upperFeather(c)+";\n";b+="uniform float "+a.lowerFeather(c)+";\n"});return b},glslAttributeDefinitions:function(){var a=this,b="";Object.keys(this.parameters).forEach(function(c){b+="attribute float "+a.attributeParameter(a.parameters[c])+";\n"});return b},glslVaryingDefinitions:function(){var a=this,
b="";Object.keys(this.parameters).forEach(function(c){b+="varying float "+a.varyingParameter(a.parameters[c])+";\n"});return b+="varying vec3 vNormal;"},glslVaryingAssignments:function(){var a=this,b="";Object.keys(this.parameters).forEach(function(c){c=a.parameters[c];b+=a.varyingParameter(c)+" = "+a.attributeParameter(c)+";\n"});return b},glslApplyConstraints:function(){var a="float constraintsOpacity = 1.0;\n",b=this;Object.keys(this.parameters).forEach(function(c){var d=b.parameters[c],e,h,f;
c=b.lowerConstraint(d);e=b.lowerFeather(d);h=b.upperConstraint(d);f=b.upperFeather(d);d=b.varyingParameter(d);a+="constraintsOpacity *= smoothstep("+c+" - "+e+"*0.5, "+c+" + "+e+"*0.5, "+d+");\n";a+="constraintsOpacity *= (1.0 - smoothstep("+h+" - "+f+"*0.5, "+h+" + "+f+"*0.5, "+d+"));\n"});return a+="gl_FragColor.a *= constraintsOpacity;\n"},glslApplyColorGradient:function(){var a=this.colorGradient,b=this.varyingParameter(this.colorGradientParameter),c,d,e;a.forEachColor(function(a,f){e=d;d=a;c=
c?c+("gl_FragColor = mix(gl_FragColor, "+f.glslLiteral()+",smoothstep(float("+e+"), float("+d+"), "+b+"));\n"):"gl_FragColor = "+f.glslLiteral()+";\n"});console.log(c);return c},glslApplyCheckerPattern:function(){var a=this.checkerPattern,b=this,c="gl_FragColor.rgb = mix(gl_FragColor.rgb, "+a.color().glslLiteral()+".rgb, "+b.checkerOpacity()+"*floor(mod(0.0";a.forEachParameter(function(a,e,h){c+=" + floor((float("+b.varyingParameter(a)+") - float("+h+")) / float("+e+"))"});return c+=", 2.0)));"},
generateVertexShader:function(){var a,b=this.parameters;a=""+this.glslUniformDefinitions(b);a+=this.glslAttributeDefinitions(b);a+=this.glslVaryingDefinitions(b);a+="void main() {\n  vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n";a+=this.glslVaryingAssignments(b);a+="  gl_Position = projectionMatrix * mvPosition;\n";a+="  vNormal = (modelViewMatrix*vec4(normal, 1.0)).xyz;";return a+="}\n"},glslDiscard:function(){return"if (gl_FragColor.a < 0.0001) { discard; }\n"},generateFragmentShader:function(){var a,
b=this.parameters;a=""+this.glslUniformDefinitions(b);a+=this.glslVaryingDefinitions(b);a+="vec3 applyLight(vec3 color, float intensity, vec3 direction, vec3 normal) {vec3 diffuse = intensity * (color * clamp(dot(normalize(direction), normal), 0.0, 1.0));";a+="return diffuse;";a+="}";a+="void main() {\n";a+=this.glslApplyColorGradient();a+=this.glslApplyCheckerPattern();a+=this.glslApplyConstraints();a+=this.glslDiscard();a+="vec3 normal = normalize(vNormal);";a+="vec3 component1 = (applyLight(vec3(1.0, 1.0, 1.0), 0.8, vec3(-1.0, -1.0, -0.4), normal));";
a+="vec3 component2 = (applyLight(vec3(1.0, 1.0, 1.0), 0.3, vec3(1.0, 1.0, -0.4), normal));";a+="vec3 ambient = vec3(0.3, 0.3, 0.3);";a+="gl_FragColor.rgb *= (ambient + component1 + component2);";return a+="}"}});CALC.Application=function(a,b){var c=this;this.visualizations=[];this.visualization=null;this.$container=a;this.scheduler=CALC.scheduler;this.stats=null;this.t=0;a.bind("contextmenu",function(){return!1});Detector.webgl||Detector.addGetWebGLMessage();this.$container.html('<header><span id="logo">continuous<sup>PREVIEW</sup></span><span id="visualization-menu">\u00bb</span></header><div id="visualization"></div><div id="loading"><p>Loading...</p></div>');$(window).resize(function(){c.updateWindow()});
b&&(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.bottom="0px",this.stats.domElement.style.right="0px",$("body").append(this.stats.domElement));this.render()}.extend({updateWindow:function(){this.visualization&&this.visualization.updateRenderers()},render:function(){var a=this;requestAnimationFrame(function(){a.render()});this.scheduler.tick();this.visualization&&this.visualization.render();this.stats&&this.stats.update()},createVisualizationButton:function(a){var b=
this,c=$('<a href="#">'+a.title+"</a>");c.click(function(){b.setVisualization(a,c)});return c},addVisualization:function(a){var b=this.createVisualizationButton(a);this.visualizations.push(a);$("#visualization-menu",this.$container).append(b);1===this.visualizations.length&&this.setVisualization(a,b)},setVisualization:function(a,b){this.visualization=a;this.visualization.init();$("#visualization",this.$container).replaceWith(a.dom);$("#visualization-menu a",this.$container).removeClass("active");
b.addClass("active");a.application=this;this.updateWindow()}});(CALC.VisualizationStep=function(a,b,c){this.title=a;this.actions=b;this.callback=c||function(){}}).extend({getTitle:function(){return this.title},visit:function(){var a;for(a=0;a<this.actions.length;a++)this.actions[a].perform();this.callback();MathJax.Hub.Queue(["Typeset",MathJax.Hub])},leave:function(){var a;for(a=0;a<this.actions.length;a++)this.actions[a].unperform()}});
(CALC.VisualizationAction=function(){}).extend({perform:function(){throw new CALC.AbstractCallException;},unperform:function(){throw new CALC.AbstractCallException;}});
(CALC.AbsoluteRotationAction=function(a){this.object=a.object;this.x=a.x;this.y=a.y;this.z=a.z;this.duration=a.duration;this.delay=a.delay;this.interpolation=a.interpolation}).inheritsFrom(CALC.VisualizationAction,{perform:function(){CALC.rotate(this.object,{x:this.x,y:this.y,z:this.z},{duration:this.duration,interpolation:this.interpolation})},unperform:function(){}});
(CALC.TextPanelAction=function(a){this.panel=a.panel;this.elem=a.elem}).inheritsFrom(CALC.VisualizationAction,{perform:function(){this.panel.append(this.elem)},unperform:function(){this.elem.detach()}});(CALC.FadeAction=function(a){this.material=a.material;this.opacity=a.opacity;this.duration=a.duration}).inheritsFrom(CALC.VisualizationAction,{perform:function(){CALC.fade(this.material,{opacity:this.opacity},{duration:this.duration,interpolation:this.interpolation})},unperform:function(){}});
(CALC.CameraAction=function(a){this.camera=a.camera;this.perspective=a.perspective;this.zoom=a.zoom;this.duration=a.duration;this.delay=a.delay;this.interpolation=a.interpolation}).inheritsFrom(CALC.VisualizationAction,{perform:function(){CALC.animateCamera(this.camera,{perspective:this.perspective,zoom:this.zoom},{duration:this.duration,interpolation:this.interpolation})},unperform:function(){}});
(CALC.MaterialUniformAction=function(a){var b;this.material=a.material;delete a.material;this.duration=a.duration;delete a.duration;this.delay=a.delay;delete a.delay;this.interpolation=a.interpolation;delete a.interpolation;this.parameters={};for(b in a)a.hasOwnProperty(b)&&(this.parameters[b]=a[b])}).inheritsFrom(CALC.VisualizationAction,{perform:function(){var a,b=this.parameters;for(a in b)b.hasOwnProperty(a)&&CALC.animate(this.material.uniforms[a],{value:b[a]},this.duration,this.interpolation,
this.delay,null,null)},unperform:function(){}});CALC.visualizations={};
(CALC.visualizations.Visualization=function(a){this.title=a;this.renderers={};this.scenes={};this.application=null;this.steps=[];this.currentStep=-1;this.stepLinks=[];this.lastRender=""}).extend({render:function(a){function b(b){THREE.SceneUtils.traverseHierarchy(b.scene,function(c){"function"===typeof c.prepareFrame&&c.prepareFrame(b,a)})}var c,d;for(d in this.renderers)this.renderers.hasOwnProperty(d)&&(c=this.renderers[d],b(c),c.scene&&c.camera&&c.render(c.scene,c.camera))},attachRenderer:function(a,
b,c,d){var e=CALC.mouseHandler;b.setSize(a.innerWidth(),a.innerHeight());b.camera=d;b.scene=c;b.mouseStrategy=new CALC.MouseStrategy(b);c=$(b.domElement);a.append(c);c.mousedown(function(a){e.mouseDown(b.mouseStrategy,a)});c.mouseup(function(a){e.mouseUp(b.mouseStrategy,a)});c.mousemove(function(a){e.mouseMove(b.mouseStrategy,a)});c.mousewheel(function(a,c){e.mouseWheel(b.mouseStrategy,a,c)});b.domElement.touchStart=function(a){e.touchStart(b.mouseStrategy,a)};b.domElement.touchMove=function(a){e.touchMove(b.mouseStrategy,
a)};return b},updateRenderers:function(){var a,b,c,d,e;c=this.renderers;for(e in c)c.hasOwnProperty(e)&&(d=c[e],a=$(d.domElement).parent(),b=a.innerWidth()-400,a=a.innerHeight(),b&&a?(d.setSize(b,a),d.camera.aspect=b/a,d.camera.updateProjectionMatrix()):d.setSize(0,0));this.render(!0)},appendTextBox:function(a,b){var c=$('<div class="text-box"></div>');c.html(b);c.hide();a.append(c);c.slideDown("slow")},appendPanel:function(a,b){a.append(b)},clearPanel:function(a,b){a.html(b)},standardVisualizationSetup:function(){var a,
b,c,d,e=this;this.nextButton=$('<a class="next-button" href="#">Continue</a>');this.dom=$('<div id="visualization"></div>');b=$('<div id="main-row"></div>');this.dom.append(b);b.append($('<div id="graphics-panel"></div>'));a=$('<div id="side-panel"></div>');b.append(a);b=$('<div id="text-panel"></div>');a.append(b);a.append(this.nextButton);this.nextButton.click(function(){e.visitNextStep()});this.panels={graphics:$("#graphics-panel",this.dom),text:$("#text-panel",this.dom),navigation:$("#navigation-panel",
this.dom)};a=new THREE.WebGLRenderer({antialias:!0});c=new THREE.Scene;new THREE.Vector3(0,0,0);b=new CALC.Camera;b.position.y=-20;c.add(b);b.rotation=new THREE.Vector3(Math.PI/2,0,0);d=new THREE.AmbientLight(2631720);c.add(d);d=new THREE.PointLight(16777215);d.position=new THREE.Vector3(4,-2,1);c.add(d);this.scenes.std=c;this.renderers.std=this.attachRenderer(this.panels.graphics,a,c,b)},setSteps:function(a){function b(a){return function(){c.visitStep(a)}}var c=this,d;this.steps=a;this.stepLinks=
[];for(a=0;a<this.steps.length;a++)d=$('<a class="visualization-step">'+this.steps[a].getTitle()+"</a> "),d.click(b(a)),this.stepLinks.push(d),this.panels.navigation.append(d)},visitStep:function(a){this.stepLinks[this.currentStep]&&this.stepLinks[this.currentStep].removeClass("active");a<=this.currentStep&&this.steps[a]&&this.steps[this.currentStep].leave();var b=this.steps[a];b&&(b.visit(),this.stepLinks[a].addClass("active"),this.currentStep=a);a+1===this.steps.length&&this.nextButton.remove()},
visitNextStep:function(){var a=this.currentStep+1;this.steps.length>a&&this.visitStep(a)}});(CALC.visualizations.TangentialPlane=function(a){CALC.visualizations.Visualization.call(this,a)}).inheritsFrom(CALC.visualizations.Visualization,{init:function(){function a(a){n&&h.remove(n);m&&h.remove(m);t&&(t.detach(),h.remove(t));n=new CALC.FunctionSurface({z:a,domain:{x:[-10,10],y:[-10,10]},attributes:{r:CALC.parse("(x^2 + y^2)^(1/2)"),d:a.differentiate()},constraints:{r:{lower:0,upper:-5,upperFeather:10}},resolution:l,appearance:{checkerPattern:{opacity:0.1,color:new CALC.Color(34,0,0),x:1,
y:1},colorGradientParameter:"z",colorGradient:{"-3":new CALC.Color(221,85,0,255),2:new CALC.Color(255,187,0,255)}}});h.add(n)}function b(a){m&&h.remove(m);t&&(t.detach(),h.remove(t));m=new CALC.FunctionSurface({z:a,domain:{x:[-10,10],y:[-10,10]},attributes:{r:CALC.parse("(x^2 + y^2)^(1/2)"),d:a.differentiate()},constraints:{r:{lower:0,upper:-5,upperFeather:10}},resolution:10,appearance:{checkerPattern:{opacity:0.1,color:new CALC.Color(34,0,0),x:1,y:1},colorGradientParameter:"z",colorGradient:{"-5":new CALC.Color(0,
34,170,133),5:new CALC.Color(0,102,255,133)}}});m.material.transparent=!0;h.add(m)}function c(){n.animate({milliseconds:3E3,interpolation:CALC.interpolations.easeOut,constraints:{r:{upper:20}},end:function(){m||b(q)}});f||(f=new CALC.Label3D(d.renderers.std,$('<math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mwrow></mfenced></math>')),f.position.x=-5,f.position.y=-5,h.add(f))}var d=this;this.standardVisualizationSetup();var e=this.scenes.std,h=new THREE.Object3D;e.add(h);
var f,l=0.2,j,q,n,m,t,x=Math.PI,w=-Math.PI;this.renderers.std.mouseStrategy=new CALC.NavigationStrategy(this.renderers.std,h);var e=$('<div class="text-box"></div>'),r=$("<p>V\u00e4lj en funktion av tv\u00e5 variabler.</p>"),u=$('<input class="function-input" value="cos(x)*sin(y)"></input>'),s=$('<a class="action-button">Rita ytan</a>');s.click(function(){j=CALC.parse(u.val());q=CALC.tangentialPlane(j,x,w);a(j);c()});e.append(r);e.append(u);e.append(s);var r=$('<div class="text-box"></div>'),s=$("<p>V\u00e4lj en punkt d\u00e4r du vill r\u00e4kna ut ett tangentplan</p>"),
C=$('<input class="scalar-input" value="0"></input>'),A=$('<input class="scalar-input" value="0"></input>'),v=$('<a class="action-button">Rita tangentplanet</a>');v.click(function(){x=parseFloat(C.val());w=parseFloat(A.val());q=CALC.tangentialPlane(j,x,w);b(q);m.animate({milliseconds:3E3,interpolation:CALC.interpolations.easeOut,constraints:{r:{upper:20}}});t=new CALC.Button3D(d.renderers.std,$("<p></p>"),function(){});t.position.set(x,w,j.evaluate({x:x,y:w}));h.add(t)});r.append(s);r.append(C);r.append(A);
r.append(v);e=new CALC.VisualizationStep("",[new CALC.TextPanelAction({panel:this.panels.text,elem:e})]);r=new CALC.VisualizationStep("",[new CALC.TextPanelAction({panel:this.panels.text,elem:r})],function(){j||(j=CALC.parse(u.val()),a(j),c())});this.setSteps([e,r]);this.visitStep(0)}});CALC.visualizations.TangentialPlaneInteractive=function(a){CALC.visualizations.Visualization.call(this,a)};CALC.visualizations.TangentialPlaneInteractive.prototype=new CALC.visualizations.Visualization;CALC.visualizations.TangentialPlaneInteractive.prototype.constructor=CALC.visualizations.TangentialPlaneInteractive;
CALC.visualizations.TangentialPlaneInteractive.prototype.init=function(){var a=this;this.standardVisualizationSetup();var b=this.scenes.std,c=new CALC.CheckerMaterial,d=new THREE.MeshBasicMaterial({color:"0x407dbc",opacity:0}),e=new THREE.MeshBasicMaterial({color:"0xffffff",opacity:0});c.uniforms.opacity.value=0;this.tgSphereObject=new THREE.Mesh(new THREE.SphereGeometry(0.125,16,16),e);var h=new THREE.Object3D;h.add(this.tgSphereObject);THREE.Vector3(0,0,0);this.boundingBox=[-10,-10,10,10];this.resolution=
0.2;this.generateSurface=function(b,e,f){try{a.fnSurfExpr=CALC.parse(b),a.fnXCurveExpr=a.fnSurfExpr.replace({x:"s",y:Math.PI/2}),a.fnYCurveExpr=a.fnSurfExpr.replace({x:0,y:"s"}),a.parameterExpr=CALC.parse("s"),a.constantExpr=CALC.parse("0")}catch(l){console.log("Could not parse exception");return}if(a.fnSurfExpr){var j;b=a.fnSurfExpr.evaluate({x:e,y:f});a.vectXObject=j;j=CALC.tangentialPlane(a.fnSurfExpr,e,f);j=CALC.buildFunctionSurface(j,a.boundingBox,a.boundingBox[2]-a.boundingBox[0],d);j.position.set(0,
0,0);a.tgPlaneObject&&h.remove(a.tgPlaneObject);h.add(j);a.tgPlaneObject=j;a.tgSphereObject.position.set(e,f,b);j=CALC.buildFunctionSurface(a.fnSurfExpr,a.boundingBox,a.resolution,c);c.setZInterval([j.getBoundingBox().min.z,j.getBoundingBox().max.z]);j.position.set(0,0,0);a.fnSurfObject&&h.remove(a.fnSurfObject);h.add(j);a.fnSurfObject=j}else console.log("Expression is undefined")};b.add(h);this.renderers.std.mouseStrategy=new CALC.NavigationStrategy(this.renderers.std,h);var b=$('<div class="text-box"></div>'),
f=$("<p>Mata in en funktion av 2 variabler</p>");b.append(f);var l=$('<form action="#"></form>'),j=$('<input type="text" value="cos(x)*cos(y)">');l.submit(function(){a.generateSurface(j.val(),parseFloat(m.val()),parseFloat(t.val()))});l.append(j);$("input",l).change(function(){l.submit()});f.append(l);f=$('<a href="#" class="next-button">G\u00e5 vidare</a>');b.append(f);f.click(function(){a.visitStep(1)});var f=$('<div class="text-box"></div>'),q=$("<p>V\u00e4lj en punkt att bilda ett tangentplan i.</p>");
f.append(q);var n=$('<form action="#"></form>'),m=$('<input type="text" value="1">'),t=$('<input type="text" value="0">');n.submit(function(){a.generateSurface(j.val(),parseFloat(m.val()),parseFloat(t.val()))});n.append(m).append(t);$("input",n).change(function(){n.submit()});f.append(n);b=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:b}),new CALC.AbsoluteRotationAction({object:h,x:0.4,z:0,duration:100,interpolation:CALC.interpolations.quintic}),
new CALC.MaterialUniformAction({material:c,opacity:1,duration:100,interpolation:CALC.interpolations.quintic}),new CALC.FadeAction({material:d,opacity:0,duration:30,interpolation:CALC.interpolations.quintic}),new CALC.FadeAction({material:e,opacity:0,duration:30,interpolation:CALC.interpolations.quintic})]);e=new CALC.VisualizationStep("Tangentplan",[new CALC.TextPanelAction({panel:this.panels.text,elem:f}),new CALC.AbsoluteRotationAction({object:h,x:0.4,z:-Math.PI/4,duration:100,interpolation:CALC.interpolations.quintic}),
new CALC.FadeAction({material:d,opacity:0.5,duration:30,interpolation:CALC.interpolations.quintic}),new CALC.FadeAction({material:e,opacity:1,duration:30,interpolation:CALC.interpolations.quintic})]);this.setSteps([b,e]);this.visitStep(0);a.boundingBox=[-10,-10,10,10];l.submit()};(CALC.visualizations.VectorTest=function(a){CALC.visualizations.Visualization.call(this,a)}).inheritsFrom(CALC.visualizations.Visualization,{init:function(){var a,b,c,d,e;this.standardVisualizationSetup();a=this.scenes.std;b=new CALC.VectorArrow(0,0,CALC.parse("x"),16711680);c=new THREE.AxisHelper;a.add(b);a.add(c);d=function(){CALC.translate(b,{x:-5,z:-2},{duration:100,interpolation:CALC.interpolations.linear},e)};e=function(){CALC.translate(b,{x:5,z:2},{duration:100,interpolation:CALC.interpolations.linear},
d)};d();a=new CALC.VisualizationStep("Vektor",[]);this.setSteps([a]);this.visitStep(0)}});(CALC.visualizations.Optimization=function(a){CALC.visualizations.Visualization.call(this,a)}).inheritsFrom(CALC.visualizations.Visualization,{init:function(){function a(a){D.abort();var b=Math.atan2(u[a].y,u[a].x),c=CALC.interpolations.sinusodial;D&&D.abort();var d,b=b%(2*Math.PI);b>Math.PI&&(b-=2*Math.PI);b<-Math.PI&&(b+=2*Math.PI);D=CALC.animator.animate({milliseconds:1500,interpolation:c,begin:function(){d=Math.atan2(y.position.y,y.position.x);Math.atan2(z.position.y,z.position.x);d-b>Math.PI&&
(d-=2*Math.PI);b-d>Math.PI&&(d+=2*Math.PI)},step:function(a){a=b*a+d*(1-a);y.position.x=Math.cos(a);y.position.y=Math.sin(a);y.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)});z.position.x=Math.cos(a);z.position.y=Math.sin(a);z.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)})-0.05},end:function(){}});$(".boxbutton").removeClass("selected");$("#sol"+a).addClass("selected")}var b=this;this.standardVisualizationSetup();var c=this.scenes.std;this.renderers.std.camera.zoom(12,!0);var d=new THREE.Object3D;
c.add(d);d.rotation=new THREE.Vector3(Math.PI/8,0,2*Math.PI/5);var e=CALC.parse("(2*u + 3*v + 1)^2 / 25"),h=e.replace({u:"x",v:"y"}),f=CALC.parse("x^2 + y^2"),l=CALC.parse("(8*x + 12*y + 4) / 25"),j=CALC.parse("(12*x + 18*y + 6) / 25");l.mathML();l.mathML();var q=CALC.parse("(2*x + 3*y + 1)^2").mathML(),c=CALC.parse("4*(2*x + 3*y + 1)").mathML(),n=CALC.parse("6*(2*x + 3*y + 1").mathML(),m=f.mathML(),t=new CALC.ParametricSurface({x:CALC.parse("u"),y:CALC.parse("v"),z:e,domain:{u:[-2,2],v:[-2,2]},attributes:{r:f},
constraints:{r:{upper:8,upperFeather:4}},resolution:0.1,appearance:{checkerPattern:{opacity:0.1,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"-2.5":new CALC.Color(0,0,204,255),"5.0":new CALC.Color(0,204,204,255)}}}),x=new THREE.Geometry;x.vertices.push(new THREE.Vector3(-3,0,0));x.vertices.push(new THREE.Vector3(3,0,0));var w=new THREE.Geometry;w.vertices.push(new THREE.Vector3(0,-3,0));w.vertices.push(new THREE.Vector3(0,3,0));e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,
0,-3));e.vertices.push(new THREE.Vector3(0,0,3));var f=new THREE.LineBasicMaterial({color:4473924}),r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>x</mi></math>"));r.position.set(3,0,0);d.add(r);r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>y</mi></math>"));r.position.set(0,3,0);d.add(r);r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>z</mi></math>"));r.position.set(0,0,3);d.add(r);var r=Math.sqrt,u=[{},{},{},{}],s=[],C=[],A=[];u[0]=new THREE.Vector3(2/13*(3*r(3)-1),1/13*(-3-
4*r(3)),0);u[1]=new THREE.Vector3(-2/13*(1+3*r(3)),1/13*(4*r(3)-3),0);u[2]=new THREE.Vector3(-2/r(13),-3/r(13),0);u[3]=new THREE.Vector3(2/r(13),3/r(13),0);A[0]=$('Lokalt min, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>0</mn></msub><mo>,</mo><msub><mi>y</mi><mn>0</mn></msub></mrow></mfenced><mo>=</mo><mn>0</mn></math>');A[1]=$('Lokalt min, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub></mrow></mfenced><mo>=</mo><mn>0</mn></math>');
A[2]=$('Lokalt max, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>2</mn></msub><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>-</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math>');A[3]=$('Globalt max, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>3</mn></msub><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math>');
for(var v=0;4>v;v++)u[v].z=h.evaluate({x:u[v].x,y:u[v].y}),function(c){var e=new CALC.Button3D(b.renderers.std,$("<p></p>"),function(){a(c)},function(){$("#sol"+c).addClass("hover")},function(){$("#sol"+c).removeClass("hover")});e.position=u[v];e.setEnabled(!1);e.setOpacity(0);d.add(e);s.push(e);e=new CALC.Label3D(b.renderers.std,A[v],10,10);e.position=u[v];d.add(e);e.setOpacity(0);C.push(e)}(v);x=new THREE.Line(x,f);w=new THREE.Line(w,f);e=new THREE.Line(e,f);d.add(x);d.add(w);d.add(e);var E=new CALC.ParametricSurface({x:CALC.parse("u"),
y:CALC.parse("v"),z:CALC.parse("(2*u + 3*v + 1)^2 / 25 + 0.01"),domain:{u:[-1.2,1.2],v:[-1.2,1.2]},attributes:{r:CALC.parse("x^2 + y^2"),zabs:CALC.parse("(v*v)^0.5")},constraints:{r:{lower:0.98,upper:1.02},zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(255,255,255,255)}}}),F=new CALC.ParametricSurface({x:CALC.parse("u"),y:CALC.parse("v"),z:CALC.parse("(2*u + 3*v + 1)^2 / 25 - 0.01"),
domain:{u:[-1.2,1.2],v:[-1.2,1.2]},attributes:{r:CALC.parse("x^2 + y^2"),zabs:CALC.parse("(v*v)^0.5")},constraints:{r:{lower:0.98,upper:1.02},zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(255,255,255,255)}}}),B=new CALC.ParametricSurface({x:CALC.parse("cos(u)"),y:CALC.parse("sin(u)"),z:CALC.parse("v"),domain:{u:[0,2*Math.PI],v:[-1.2,1.2]},attributes:{zabs:CALC.parse("(v*v)^0.5")},
constraints:{zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:1,y:1},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(204,0,34,68)}}});B.material.transparent=!0;B.position.z=0.5;d.add(t);var y=new CALC.VectorArrow(new CALC.Addition({left:l,right:CALC.parse("x/100")}),new CALC.Addition({left:j,right:CALC.parse("y/100")}),0,2250188),z=new CALC.VectorArrow(CALC.parse("x"),CALC.parse("y"),0,16720418),D,G,H;this.renderers.std.mouseStrategy=
new CALC.NavigationStrategy(this.renderers.std,d);l=$('<div class="text-box"></div>');e=$("<p>Optimering med bivillkor inneb\u00e4r att hitta extremv\u00e4rden hos en funktion givet att vissa begr\u00e4nsningar g\u00e4ller. H\u00e4r \u00e4r en f\u00f6rklaring med hj\u00e4lp av ett exempel, d\u00e4r vi ska hitta st\u00f6rsta v\u00e4rdet i en funktionsytas sk\u00e4rning med enhetscirkeln.</p>");j=$("<p>Betrakta funktionsytan </p>");l.append(e);l.append(j);q=$('<math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo>'+
q+"</math>");j.append(q);q=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:l})]);l=$('<div class="text-box"></div>');j=$("<p>Vi ritar v\u00e5rt bivillkor - enhetscirkeln, <math>"+m+"<mo>=</mo><mn>1</mn></math> som i tre dimensioner kan visualiseras som en cylinder.</p>");e=$('<p>Vi s\u00f6ker allts\u00e5 det st\u00f6rsta v\u00e4rdet som <math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced></math> antar p\u00e5 sk\u00e4rningen av cylindern.</p>');
l.append(j);l.append(e);l=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:l})],function(){d.add(B);d.add(E);d.add(F);B.animate({milliseconds:2E3,interpolation:CALC.interpolations.easeOut,constraints:{zabs:{upper:1,lower:-1,upperFeather:0}}});setTimeout(function(){E.animate({milliseconds:2E3,interpolation:CALC.interpolations.sinusodial,constraints:{zabs:{upper:1,lower:-1,upperFeather:10}}})},0)});j=$('<div class="text-box"></div>');m=$('<p>Det st\u00f6rsta funktionsv\u00e4rdet som uppfyller bivillkoret kommer att finnas i en punkt d\u00e4r gradienten till <math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced></math> \u00e4r parallell med gradienten till <math><mi>g</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo>'+
m+'</math>. Det g\u00e5r att se att</p><math style="color: #800"><mo mathvariant="bold">&nabla;</mo><mi>g</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo><mfenced><mtable><mtr><mtd><mn>2</mn><mi>x</mi></mtd></mtr><mtr><mtd><mn>2</mn><mi>y</mi></mtd></mtr></mtable></mfenced></math> <p>\u00e4r parallell med enhetscirkelns normal. Vi kan \u00e4ven ber\u00e4kna </p>');e=$('<p><math style="color: #008"><mo mathvariant="bold">&nabla;</mo><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo><mfenced><mtable><mtr><mtd>'+
c+"</mtd></mtr><mtr><mtd>"+n+"</mtd></mtr></mtable></mfenced></math>");f=$("<p>Den bl\u00e5 vektorpilen som cirkulerar representerar ytans gradient, medan den r\u00f6da pekar i cylinderns normals riktning.</p>");c=$('<p>De tv\u00e5 vektorerna \u00e4r paralella d\u00e5 och endast d\u00e5</p><math><mfenced open="|" close="|"><mtable><mtr><mtd>'+c+"</mtd><mtd>"+n+"</mtd></mtr><mtr><mtd><mn>2</mn><mi>x</mi></mtd><mtd><mn>2</mn><mi>y</mi></mtd></mtr></mtable></mfenced><mo>=</mo><mn>0</mn></math>");j.append(m);
j.append(e);j.append(f);j.append(c);c=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:j})],function(){t.animate({milliseconds:3E3,interpolation:CALC.interpolations.easeOut,constraints:{r:{lower:0,upper:1,upperFeather:0}}});var a=function(){D=CALC.animator.animate({milliseconds:1E4,interpolation:CALC.interpolations.linear,begin:function(){},step:function(a){a=2*a*Math.PI;y.position.x=Math.cos(a);y.position.y=Math.sin(a);y.position.z=h.evaluate({x:Math.cos(a),
y:Math.sin(a)});z.position.x=Math.cos(a);z.position.y=Math.sin(a);z.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)})-0.05},end:function(){a()}})};y.position.set(1,0,h.evaluate({x:0,y:1}));z.position.set(1,0,h.evaluate({x:0,y:1})-0.05);d.add(y);d.add(z);a()});n=$('<div class="text-box"></div>');m=$('<p>Determinantekvationen ger tillsammans med bivillkoret l\u00f6sningarna</p><a class="boxbutton" id="sol0"><div class="smallButton"></div><math><msub><mi>x</mi><mn>0</mn></msub><mo>=</mo><mfrac><mn>2</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>3</mn><msqrt><mn>3</mn></msqrt><mo>-</mo><mn>1</mn></mrow></mfenced><mo>,</mo><msub><mi>y</mi><mn>0</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>1</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>4</mn><msqrt><mn>3</mn></msqrt><mo>+</mo><mn>3</mn></mrow></mfenced></math></a><a class="boxbutton" id="sol1"><div class="smallButton"></div><math><msub><mi>x</mi><mn>1</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>2</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>3</mn><msqrt><mn>3</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mfrac><mn>1</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>4</mn><msqrt><mn>3</mn></msqrt><mo>-</mo><mn>3</mn></mrow></mfenced></math></a><a class="boxbutton" id="sol2"><div class="smallButton"></div><math><msub><mi>x</mi><mn>2</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>2</mn><msqrt><mn>13</mn></msqrt></mfrac><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>3</mn><msqrt><mn>13</mn></msqrt></mfrac></math></a><a class="boxbutton" id="sol3"><div class="smallButton"></div><math><msub><mi>x</mi><mn>3</mn></msub><mo>=</mo><mfrac><mn>2</mn><msqrt><mn>13</mn></msqrt></mfrac><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub><mo>=</mo><mfrac><mn>3</mn><msqrt><mn>13</mn></msqrt></mfrac></math></a>De fyra l\u00f6sningarna visualiseras med varsina vita cirkar. Klicka p\u00e5 cirklarna eller p\u00e5 l\u00f6sningarna ovan f\u00f6r att se hur gradient och cylindernormal pekar just i dessa punkter.</p>');
n.append(m);n=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:n})],function(){a(0);G=CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.linear,begin:function(){G&&G.abort();for(var a=0;4>a;a++)s[a].setEnabled(!0)},step:function(a){for(var b=0;4>b;b++)s[b].setOpacity(0.4*a)},end:function(){}});$("#sol0").click(function(){a(0)});$("#sol1").click(function(){a(1)});$("#sol2").click(function(){a(2)});$("#sol3").click(function(){a(3)});
$("#sol0").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[0].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol1").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[1].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol2").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[2].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol3").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});
s[3].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})})});m=$('<div class="text-box"></div>');j=$('<p>Genom att j\u00e4mf\u00f6ra funktionsv\u00e4rdet i de olika punkterna g\u00e5r det att hitta det st\u00f6rsta v\u00e4rdet: <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>3</mn></msub><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math></p>');
m.append(j);m.append(j);m=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:m})],function(){a(3);H=CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.linear,begin:function(){H&&H.abort()},step:function(a){for(var b=0;4>b;b++)C[b].setOpacity(0.8*a)},end:function(){}});var c=0,e=b.renderers.std.camera;CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.sinusodial,begin:function(){c=e.getZoom()},step:function(a){e.zoom(34*
a+(1-a)*c,!0)},end:function(){}});console.log(d);CALC.animator.animateProperties({object:d.position,parameters:{x:0,y:0,z:0},milliseconds:1E3,interpolation:CALC.interpolations.sinusodial})});this.setSteps([q,l,c,n,m]);this.visitStep(0)}});(CALC.visualizations.OptimizationEN=function(a){CALC.visualizations.Visualization.call(this,a)}).inheritsFrom(CALC.visualizations.Visualization,{init:function(){function a(a){D.abort();var b=Math.atan2(u[a].y,u[a].x),c=CALC.interpolations.sinusodial;D&&D.abort();var d,b=b%(2*Math.PI);b>Math.PI&&(b-=2*Math.PI);b<-Math.PI&&(b+=2*Math.PI);D=CALC.animator.animate({milliseconds:1500,interpolation:c,begin:function(){d=Math.atan2(y.position.y,y.position.x);Math.atan2(z.position.y,z.position.x);d-b>Math.PI&&
(d-=2*Math.PI);b-d>Math.PI&&(d+=2*Math.PI)},step:function(a){a=b*a+d*(1-a);y.position.x=Math.cos(a);y.position.y=Math.sin(a);y.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)});z.position.x=Math.cos(a);z.position.y=Math.sin(a);z.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)})-0.05},end:function(){}});$(".boxbutton").removeClass("selected");$("#sol"+a).addClass("selected")}var b=this;this.standardVisualizationSetup();var c=this.scenes.std;this.renderers.std.camera.zoom(12,!0);var d=new THREE.Object3D;
c.add(d);d.rotation=new THREE.Vector3(Math.PI/8,0,2*Math.PI/5);var e=CALC.parse("(2*u + 3*v + 1)^2 / 25"),h=e.replace({u:"x",v:"y"}),f=CALC.parse("x^2 + y^2"),l=CALC.parse("(8*x + 12*y + 4) / 25"),j=CALC.parse("(12*x + 18*y + 6) / 25");l.mathML();l.mathML();var q=CALC.parse("(2*x + 3*y + 1)^2").mathML(),c=CALC.parse("4*(2*x + 3*y + 1)").mathML(),n=CALC.parse("6*(2*x + 3*y + 1").mathML(),m=f.mathML(),t=new CALC.ParametricSurface({x:CALC.parse("u"),y:CALC.parse("v"),z:e,domain:{u:[-2,2],v:[-2,2]},attributes:{r:f},
constraints:{r:{upper:8,upperFeather:4}},resolution:0.1,appearance:{checkerPattern:{opacity:0.1,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"-2.5":new CALC.Color(0,0,204,255),"5.0":new CALC.Color(0,204,204,255)}}}),x=new THREE.Geometry;x.vertices.push(new THREE.Vector3(-3,0,0));x.vertices.push(new THREE.Vector3(3,0,0));var w=new THREE.Geometry;w.vertices.push(new THREE.Vector3(0,-3,0));w.vertices.push(new THREE.Vector3(0,3,0));e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,
0,-3));e.vertices.push(new THREE.Vector3(0,0,3));var f=new THREE.LineBasicMaterial({color:4473924}),r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>x</mi></math>"));r.position.set(3,0,0);d.add(r);r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>y</mi></math>"));r.position.set(0,3,0);d.add(r);r=new CALC.AxisLabel3D(this.renderers.std,$("<math><mi>z</mi></math>"));r.position.set(0,0,3);d.add(r);var r=Math.sqrt,u=[{},{},{},{}],s=[],C=[],A=[];u[0]=new THREE.Vector3(2/13*(3*r(3)-1),1/13*(-3-
4*r(3)),0);u[1]=new THREE.Vector3(-2/13*(1+3*r(3)),1/13*(4*r(3)-3),0);u[2]=new THREE.Vector3(-2/r(13),-3/r(13),0);u[3]=new THREE.Vector3(2/r(13),3/r(13),0);A[0]=$('Local man, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>0</mn></msub><mo>,</mo><msub><mi>y</mi><mn>0</mn></msub></mrow></mfenced><mo>=</mo><mn>0</mn></math>');A[1]=$('Local min, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub></mrow></mfenced><mo>=</mo><mn>0</mn></math>');
A[2]=$('Local max, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>2</mn></msub><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>-</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math>');A[3]=$('Global max, <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>3</mn></msub><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math>');
for(var v=0;4>v;v++)u[v].z=h.evaluate({x:u[v].x,y:u[v].y}),function(c){var e=new CALC.Button3D(b.renderers.std,$("<p></p>"),function(){a(c)},function(){$("#sol"+c).addClass("hover")},function(){$("#sol"+c).removeClass("hover")});e.position=u[v];e.setEnabled(!1);e.setOpacity(0);d.add(e);s.push(e);e=new CALC.Label3D(b.renderers.std,A[v],10,10);e.position=u[v];d.add(e);e.setOpacity(0);C.push(e)}(v);x=new THREE.Line(x,f);w=new THREE.Line(w,f);e=new THREE.Line(e,f);d.add(x);d.add(w);d.add(e);var E=new CALC.ParametricSurface({x:CALC.parse("u"),
y:CALC.parse("v"),z:CALC.parse("(2*u + 3*v + 1)^2 / 25 + 0.01"),domain:{u:[-1.2,1.2],v:[-1.2,1.2]},attributes:{r:CALC.parse("x^2 + y^2"),zabs:CALC.parse("(v*v)^0.5")},constraints:{r:{lower:0.98,upper:1.02},zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(255,255,255,255)}}}),F=new CALC.ParametricSurface({x:CALC.parse("u"),y:CALC.parse("v"),z:CALC.parse("(2*u + 3*v + 1)^2 / 25 - 0.01"),
domain:{u:[-1.2,1.2],v:[-1.2,1.2]},attributes:{r:CALC.parse("x^2 + y^2"),zabs:CALC.parse("(v*v)^0.5")},constraints:{r:{lower:0.98,upper:1.02},zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:0.2,y:0.2},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(255,255,255,255)}}}),B=new CALC.ParametricSurface({x:CALC.parse("cos(u)"),y:CALC.parse("sin(u)"),z:CALC.parse("v"),domain:{u:[0,2*Math.PI],v:[-1.2,1.2]},attributes:{zabs:CALC.parse("(v*v)^0.5")},
constraints:{zabs:{lower:0,upper:-1,upperFeather:2}},resolution:0.1,appearance:{checkerPattern:{opacity:0,color:new CALC.Color(0,0,0),x:1,y:1},colorGradientParameter:"z",colorGradient:{"0.0":new CALC.Color(204,0,34,68)}}});B.material.transparent=!0;B.position.z=0.5;d.add(t);var y=new CALC.VectorArrow(new CALC.Addition({left:l,right:CALC.parse("x/100")}),new CALC.Addition({left:j,right:CALC.parse("y/100")}),0,2250188),z=new CALC.VectorArrow(CALC.parse("x"),CALC.parse("y"),0,16720418),D,G,H;this.renderers.std.mouseStrategy=
new CALC.NavigationStrategy(this.renderers.std,d);l=$('<div class="text-box"></div>');e=$("<p>Optimization with equality constraints means finding the extreme values of a function given the fulfillment of an equation. Here follows an example, where we will explain how to find the greatest value that a function genererates on its intersection with the unit circle.</p>");j=$("<p>Consider the function </p>");l.append(e);l.append(j);q=$('<math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo>'+
q+"</math>");j.append(q);q=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:l})]);l=$('<div class="text-box"></div>');j=$("<p>Let us plot our constraint <math>"+m+"<mo>=</mo><mn>1</mn></math>. In three dimentions, the unit circle can be visualized as a cylinder.</p>");e=$('<p>We are searching for the greatest value of <math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced></math> along the intersection with the cylinder.</p>');
l.append(j);l.append(e);l=new CALC.VisualizationStep("The Surface",[new CALC.TextPanelAction({panel:this.panels.text,elem:l})],function(){d.add(B);d.add(E);d.add(F);B.animate({milliseconds:2E3,interpolation:CALC.interpolations.easeOut,constraints:{zabs:{upper:1,lower:-1,upperFeather:0}}});setTimeout(function(){E.animate({milliseconds:2E3,interpolation:CALC.interpolations.sinusodial,constraints:{zabs:{upper:1,lower:-1,upperFeather:10}}})},0)});j=$('<div class="text-box"></div>');m=$('<p>The largest value fullfilling the constraint will be found in a position where the gradient of <math><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced></math> <em>is parallel to</em> the gradient of <math><mi>g</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo>'+
m+'</math>. We can see that </p><math style="color: #800"><mo mathvariant="bold">&nabla;</mo><mi>g</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo><mfenced><mtable><mtr><mtd><mn>2</mn><mi>x</mi></mtd></mtr><mtr><mtd><mn>2</mn><mi>y</mi></mtd></mtr></mtable></mfenced></math> <p>is parallel to the normal of the cylinder. We can also derive </p>');e=$('<p><math style="color: #008"><mo mathvariant="bold">&nabla;</mo><mi>f</mi><mfenced open="(" close=")"><mrow><mi>x</mi><mo>,</mo><mi>y</mi></mrow></mfenced><mo>=</mo><mfenced><mtable><mtr><mtd>'+
c+"</mtd></mtr><mtr><mtd>"+n+"</mtd></mtr></mtable></mfenced></math>");f=$('<p>The blue vector <math style="color: #008"><mo mathvariant="bold">&nabla;</mo><mi>f</mi></math> orbiting the cylinder represents the gradient of the of the function, while the red vector <math style="color: #800"><mo mathvariant="bold">&nabla;</mo><mi>g</mi></math> is pointing in the direction of the cylinder\'s normal.</p>');c=$('<p>The vectors are parallel if and only if </p><math><mfenced open="|" close="|"><mtable><mtr><mtd>'+
c+"</mtd><mtd>"+n+"</mtd></mtr><mtr><mtd><mn>2</mn><mi>x</mi></mtd><mtd><mn>2</mn><mi>y</mi></mtd></mtr></mtable></mfenced><mo>=</mo><mn>0</mn></math>");j.append(m);j.append(e);j.append(f);j.append(c);c=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:j})],function(){t.animate({milliseconds:3E3,interpolation:CALC.interpolations.easeOut,constraints:{r:{lower:0,upper:1,upperFeather:0}}});var a=function(){D=CALC.animator.animate({milliseconds:1E4,interpolation:CALC.interpolations.linear,
begin:function(){},step:function(a){a=2*a*Math.PI;y.position.x=Math.cos(a);y.position.y=Math.sin(a);y.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)});z.position.x=Math.cos(a);z.position.y=Math.sin(a);z.position.z=h.evaluate({x:Math.cos(a),y:Math.sin(a)})-0.05},end:function(){a()}})};y.position.set(1,0,h.evaluate({x:0,y:1}));z.position.set(1,0,h.evaluate({x:0,y:1})-0.05);d.add(y);d.add(z);a()});n=$('<div class="text-box"></div>');m=$('<p>Along with the constraints, the determinant equation generates the following roots: </p><a class="boxbutton" id="sol0"><div class="smallButton"></div><math><msub><mi>x</mi><mn>0</mn></msub><mo>=</mo><mfrac><mn>2</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>3</mn><msqrt><mn>3</mn></msqrt><mo>-</mo><mn>1</mn></mrow></mfenced><mo>,</mo><msub><mi>y</mi><mn>0</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>1</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>4</mn><msqrt><mn>3</mn></msqrt><mo>+</mo><mn>3</mn></mrow></mfenced></math></a><a class="boxbutton" id="sol1"><div class="smallButton"></div><math><msub><mi>x</mi><mn>1</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>2</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>3</mn><msqrt><mn>3</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mfrac><mn>1</mn><mn>13</mn></mfrac><mfenced open="(" close=")"><mrow><mn>4</mn><msqrt><mn>3</mn></msqrt><mo>-</mo><mn>3</mn></mrow></mfenced></math></a><a class="boxbutton" id="sol2"><div class="smallButton"></div><math><msub><mi>x</mi><mn>2</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>2</mn><msqrt><mn>13</mn></msqrt></mfrac><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub><mo>=</mo><mo>-</mo><mfrac><mn>3</mn><msqrt><mn>13</mn></msqrt></mfrac></math></a><a class="boxbutton" id="sol3"><div class="smallButton"></div><math><msub><mi>x</mi><mn>3</mn></msub><mo>=</mo><mfrac><mn>2</mn><msqrt><mn>13</mn></msqrt></mfrac><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub><mo>=</mo><mfrac><mn>3</mn><msqrt><mn>13</mn></msqrt></mfrac></math></a>The four roots are visaulized as white circles. Click on the circles or on the expressions above to see how the gradient and the normal of the cylinder are pointing in these positions.</p>');
n.append(m);n=new CALC.VisualizationStep("Funktionsytan",[new CALC.TextPanelAction({panel:this.panels.text,elem:n})],function(){a(0);G=CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.linear,begin:function(){G&&G.abort();for(var a=0;4>a;a++)s[a].setEnabled(!0)},step:function(a){for(var b=0;4>b;b++)s[b].setOpacity(0.4*a)},end:function(){}});$("#sol0").click(function(){a(0)});$("#sol1").click(function(){a(1)});$("#sol2").click(function(){a(2)});$("#sol3").click(function(){a(3)});
$("#sol0").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[0].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol1").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[1].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol2").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});s[2].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})});$("#sol3").hover(function(){s.forEach(function(a){a.setOpacity(0.4)});
s[3].setOpacity(0.9)},function(){s.forEach(function(a){a.setOpacity(0.4)})})});m=$('<div class="text-box"></div>');j=$('<p>We can now find the greatest value by comparing the function values in the four points. <math><mi>f</mi><mfenced open="(" close=")"><mrow><msub><mi>x</mi><mn>3</mn></msub><mo>,</mo><msub><mi>y</mi><mn>3</mn></msub></mrow></mfenced><mo>=</mo><msup><mrow><mfenced open="(" close=")"><mrow><msqrt><mn>13</mn></msqrt><mo>+</mo><mn>1</mn></mrow></mfenced></mrow><mn>2</mn></msup></math></p>');
m.append(j);m.append(j);m=new CALC.VisualizationStep("Function Surface",[new CALC.TextPanelAction({panel:this.panels.text,elem:m})],function(){a(3);H=CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.linear,begin:function(){H&&H.abort()},step:function(a){for(var b=0;4>b;b++)C[b].setOpacity(0.8*a)},end:function(){}});var c=0,e=b.renderers.std.camera;CALC.animator.animate({milliseconds:1E3,interpolation:CALC.interpolations.sinusodial,begin:function(){c=e.getZoom()},step:function(a){e.zoom(34*
a+(1-a)*c,!0)},end:function(){}});console.log(d);CALC.animator.animateProperties({object:d.position,parameters:{x:0,y:0,z:0},milliseconds:1E3,interpolation:CALC.interpolations.sinusodial})});this.setSteps([q,l,c,n,m]);this.visitStep(0)}});
